<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Position Size Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <base url="/forex-psc/"/>
    <style>
        /* CSS Variables for Theme Support */
        :root {
            /* Light Theme Variables */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafafa;
            --bg-accent: #e9f7fe;
            --bg-success: #e8f5e9;
            --bg-warning: #fff3cd;
            --bg-info: #e3f2fd;
            --bg-danger: #fff5f5;
            --bg-reward: #f0fff4;
            
            --text-primary: #333333;
            --text-secondary: #2c3e50;
            --text-muted: #6c757d;
            --text-light: #ffffff;
            --text-success: #2f855a;
            --text-danger: #c53030;
            
            --border-primary: #eee;
            --border-secondary: #dee2e6;
            --border-light: #ccc;
            --border-accent: #007bff;
            
            --shadow-primary: rgba(0, 0, 0, 0.1);
            --shadow-secondary: rgba(0, 0, 0, 0.2);
            
            --accent-primary: #007bff;
            --accent-success: #28a745;
            --accent-warning: #ffc107;
            --accent-danger: #dc3545;
            --accent-info: #17a2b8;
        }

        [data-theme="dark"] {
            /* Dark Theme Variables */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --bg-accent: #1e3a5f;
            --bg-success: #1e4d2b;
            --bg-warning: #4d3d1a;
            --bg-info: #1a3a4d;
            --bg-danger: #4d1a1a;
            --bg-reward: #1a4d2b;
            
            --text-primary: #e0e0e0;
            --text-secondary: #ffffff;
            --text-muted: #a0a0a0;
            --text-light: #ffffff;
            --text-success: #4ade80;
            --text-danger: #f87171;
            
            --border-primary: #404040;
            --border-secondary: #555555;
            --border-light: #666666;
            --border-accent: #0ea5e9;
            
            --shadow-primary: rgba(0, 0, 0, 0.3);
            --shadow-secondary: rgba(0, 0, 0, 0.5);
            
            --accent-primary: #0ea5e9;
            --accent-success: #22c55e;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-info: #06b6d4;
        }

        /* Styles remain unchanged */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .calculator-container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: var(--bg-secondary);
            border-radius: 10px;
            box-shadow: 0 0 20px var(--shadow-primary);
            padding: 2rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-primary);
            padding-bottom: 1rem;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .form-label {
            font-weight: 600;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        .result-box {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            border-left: 5px solid var(--border-accent);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .result-title {
            color: var(--accent-primary);
            font-weight: 600;
            margin-bottom: 1rem;
            transition: color 0.3s ease;
        }
        .result-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
        }
        .disclaimer {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-primary);
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .rate-display {
            background-color: var(--bg-accent);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            transition: background-color 0.3s ease;
        }
        .rate-display .rate {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            transition: color 0.3s ease;
        }
        .rate-display .timestamp {
            font-size: 0.85rem;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }
        .loading-spinner {
            width: 2rem;
            height: 2rem;
            border: 3px solid rgba(0, 123, 255, 0.3);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        .info-icon {
            color: #6c757d;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        .lot-selector {
            display: flex;
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        .lot-option {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            color: var(--text-primary);
        }
        .lot-option.active {
            background-color: var(--accent-primary);
            color: var(--text-light);
            font-weight: bold;
        }
        .profit-indicator {
            font-weight: 600;
        }
        .profit-indicator.positive {
            color: var(--text-success);
        }
        .profit-indicator.negative {
            color: var(--text-danger);
        }
        .risk-reward-display {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid var(--accent-primary);
            margin-top: 0.5rem;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .risk-reward-ratio {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
        }
        .risk-reward-explanation {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            font-style: italic;
            transition: color 0.3s ease;
        }
        .risk-reward-breakdown {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .risk-amount, .reward-amount {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            border-radius: 6px;
        }
        .risk-amount {
            background-color: var(--bg-danger);
            border: 1px solid var(--accent-danger);
            color: var(--text-danger);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .reward-amount {
            background-color: var(--bg-reward);
            border: 1px solid var(--accent-success);
            color: var(--text-success);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .vs-separator {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 1.1rem;
            transition: color 0.3s ease;
        }
        .form-section {
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background-color: var(--bg-tertiary);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .form-section-title {
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
            transition: color 0.3s ease;
        }
        .risk-reward-toggle {
            margin-bottom: 1rem;
        }
        .risk-reward-toggle .form-check {
            margin-right: 1.5rem;
            display: inline-block;
        }
        .nav-tabs {
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-secondary);
            transition: border-color 0.3s ease;
        }
        .nav-tabs .nav-link {
            border: none;
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .nav-tabs .nav-link.active {
            color: var(--accent-primary);
            background-color: transparent;
            border-bottom: 2px solid var(--accent-primary);
            font-weight: 600;
        }
        .tab-content {
            padding: 1rem 0;
        }
        .api-credits {
            font-size: 0.75rem;
            color: #6c757d;
            text-align: center;
            margin-top: 0.5rem;
        }
        .api-selector {
            margin-bottom: 1rem;
        }
        .api-option {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-secondary);
            transition: all 0.3s;
            margin-right: 0.5rem;
            display: inline-block;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
        }
        .api-option.active {
            background-color: var(--accent-primary);
            color: var(--text-light);
            border-color: var(--accent-primary);
        }
        .debug-info {
            font-size: 0.8rem;
            margin-top: 1rem;
            padding: 0.5rem;
            border: 1px dashed var(--border-light);
            background-color: var(--bg-tertiary);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .debug-toggle-btn {
            background-color: var(--text-secondary);
            color: var(--text-light);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
        }
        .debug-toggle-btn:hover {
            background-color: var(--text-primary);
        }
        .debug-content {
            display: none;
        }
        .refresh-rate-btn {
            border: none;
            background: none;
            color: var(--accent-primary);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .refresh-rate-btn:hover {
            background-color: var(--bg-accent);
        }
        .refresh-rate-btn:active {
            background-color: var(--bg-info);
        }
        .refresh-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 0.5rem;
        }
        .atr-display {
            background-color: var(--bg-info);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 3px solid var(--accent-info);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .atr-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent-info);
            transition: color 0.3s ease;
        }
        .atr-multiplier {
            width: 70px;
        }
        .sl-based-on-atr {
            font-weight: 600;
            color: var(--accent-info);
            transition: color 0.3s ease;
        }
        .badge-info {
            background-color: var(--accent-info);
            color: var(--text-light);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .atr-badge {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            background-color: var(--bg-info);
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
            background-color: var(--text-secondary);
            color: var(--text-light);
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            transition: background-color 0.3s ease;
        }
        .log-entry {
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.5rem;
            transition: border-color 0.3s ease;
        }
        .log-entry.api {
            color: var(--accent-info);
        }
        .log-entry.calculation {
            color: var(--accent-success);
        }
        .log-entry.error {
            color: var(--accent-danger);
        }
        .log-timestamp {
            color: var(--text-muted);
            margin-right: 0.5rem;
        }
        .toggle-logs-btn {
            background-color: var(--text-secondary);
            color: var(--text-light);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
        }
        .toggle-logs-btn:hover {
            background-color: var(--text-primary);
        }
        .global-timeframe-section {
            background-color: var(--bg-success);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 3px solid var(--accent-success);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .timeframe-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .timeframe-option {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            border: 1px solid var(--border-light);
            transition: all 0.2s;
            font-size: 0.9rem;
            text-align: center;
            flex: 1;
            min-width: 60px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        .timeframe-option:hover {
            background-color: var(--bg-tertiary);
        }
        .timeframe-option.active {
            background-color: var(--accent-success);
            color: var(--text-light);
            border-color: var(--accent-success);
            font-weight: 600;
        }
        .timeframe-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            background-color: var(--bg-success);
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
            margin-left: 0.5rem;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .scaling-info {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            font-style: italic;
            transition: color 0.3s ease;
        }
        .header-icons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }
        .header-icon {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            transition: all 0.2s;
            font-size: 1.1rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        .header-icon:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px var(--shadow-primary);
        }
        .metaapi-status-icon {
            position: relative;
        }
        .metaapi-status-icon.connected {
            color: var(--accent-success);
            background-color: var(--bg-success);
            border-color: var(--accent-success);
        }
        .metaapi-status-icon.disconnected {
            color: var(--accent-danger);
            background-color: var(--bg-danger);
            border-color: var(--accent-danger);
        }
        .metaapi-status-icon.connecting {
            color: var(--accent-warning);
            background-color: var(--bg-warning);
            border-color: var(--accent-warning);
        }
        .header {
            position: relative;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @media (max-width: 576px) {
            .calculator-container {
                padding: 1rem;
                margin: 1rem;
            }
            .result-value {
                font-size: 1.5rem;
            }
            .timeframe-option {
                padding: 0.35rem 0.5rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="header">
            <h1>Forex Position Size Calculator</h1>
            <div class="header-icons">
                <div class="header-icon" id="settings-icon" data-bs-toggle="modal" data-bs-target="#settingsModal" title="Settings">
                    <i class="bi bi-gear-fill"></i>
                </div>
                <div class="header-icon metaapi-status-icon" id="metaapi-status-icon" style="display: none;" title="MetaAPI Status">
                    <i class="bi bi-wifi"></i>
                </div>
            </div>
            <p class="lead">Calculate the optimal position size based on your risk management settings</p>
        </div>

        <form id="position-size-form">
            <div class="global-timeframe-section">
                <div class="form-section-title">Global Timeframe <span class="timeframe-badge">Strategy Setting</span></div>
                <p class="mb-2">Select the timeframe for your trading strategy. This will affect ATR calculations and other timeframe-dependent settings.</p>
                <div class="timeframe-selector">
                    <div class="timeframe-option" data-timeframe="1m">1 min</div>
                    <div class="timeframe-option" data-timeframe="5m">5 min</div>
                    <div class="timeframe-option" data-timeframe="15m">15 min</div>
                    <div class="timeframe-option" data-timeframe="30m">30 min</div>
                    <div class="timeframe-option" data-timeframe="1h">1 hour</div>
                    <div class="timeframe-option active" data-timeframe="4h">4 hour</div>
                    <div class="timeframe-option" data-timeframe="8h">8 hour</div>
                    <div class="timeframe-option" data-timeframe="1d">Daily</div>
                </div>
                <p class="scaling-info">Note: ATR values automatically scale with timeframe. Higher timeframes generally have larger ATR values.</p>
            </div>

            <div class="form-section">
                <div class="form-section-title">Pair Settings</div>
                
                <!-- Hidden fields for account settings (managed in settings modal) -->
                <input type="hidden" id="account-size" value="10000">
                <input type="hidden" id="risk-percentage" value="2">
                <input type="hidden" id="account-currency" value="USD">
                
                <div class="api-selector">
                    <label class="form-label">Rates Data Source:</label>
                    <div>
                        <span class="api-option active" data-api="metaapi">MetaAPI (Real-time)</span>
                    </div>
                </div>

                
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Account Settings:</strong> Configure your account size, risk percentage, and currency in the 
                    <button type="button" class="btn btn-link p-0 align-baseline" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        <i class="bi bi-gear-fill"></i> Settings
                    </button> panel.
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12 mb-3">
                        <label for="currency-pair" class="form-label">Currency Pair:</label>
                        <select class="form-select" id="currency-pair" required="">
                            <option value="">Select Currency Pair</option>
                            <option value="EURUSD">EUR/USD</option>
                            <option value="GBPUSD">GBP/USD</option>
                            <option value="USDJPY">USD/JPY</option>
                            <option value="AUDUSD">AUD/USD</option>
                            <option value="USDCAD">USD/CAD</option>
                            <option value="USDCHF">USD/CHF</option>
                            <option value="NZDUSD">NZD/USD</option>
                            <option value="EURJPY">EUR/JPY</option>
                            <option value="GBPJPY">GBP/JPY</option>
                            <option value="EURGBP">EUR/GBP</option>
                            <option value="AUDJPY">AUD/JPY</option>
                            <option value="EURAUD">EUR/AUD</option>
                            <option value="GBPAUD">GBP/AUD</option>
                            <option value="XAUUSD">XAU/USD (Gold)</option>
                        </select>
                        <small class="text-muted" id="symbols-status">Using default symbol list</small>
                    </div>
                </div>

                <div id="rate-display" class="rate-display" style="display: none;">
                    <div class="refresh-container">
                        <button type="button" class="refresh-rate-btn" id="refresh-rate-btn" title="Refresh Rate">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Rate
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p>Current Rate:</p>
                            <div class="rate" id="current-rate">Loading...</div>
                        </div>
                        <div class="col-md-6">
                            <p>Last Updated:</p>
                            <div class="timestamp" id="timestamp">Loading...</div>
                        </div>
                    </div>
                    <div class="api-credits" id="api-source">Exchange rates provided by MetaAPI (Real-time)</div>
                </div>

            </div>

            <div class="form-section">
                <div class="form-section-title">ATR (Average True Range) <span class="atr-badge">Volatility Indicator</span></div>
                
                <div class="atr-display" id="atr-display">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="atr-periods" class="form-label">ATR Periods:</label>
                            <select class="form-select" id="atr-periods">
                                <option value="14">14 periods (standard)</option>
                                <option value="20">20 periods</option>
                                <option value="10">10 periods</option>
                                <option value="5">5 periods</option>
                            </select>
                            <div class="mt-2">
                                <span class="fw-bold">Using: </span>
                                <span id="atr-timeframe-display">4 hour timeframe</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ATR Value (auto-fetched):</label>
                            <input type="number" class="form-control" id="atr-value" step="0.00001" placeholder="Auto-fetching or enter manually">
                            <small class="text-muted">Automatically fetched when pair/timeframe changes</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="input-group align-items-center">
                                <label class="form-label me-2 mb-0">ATR Multiplier:</label>
                                <input type="number" class="form-control atr-multiplier" id="atr-multiplier" value="2" step="0.1" min="0.1">
                                <button class="btn btn-outline-info btn-sm ms-2" type="button" id="apply-atr-btn">
                                    Apply to SL
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="sl-based-on-atr" id="sl-atr-info">
                                Stop Loss based on ATR: <span id="sl-atr-pips">-</span> pips
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="form-section">
                <div class="form-section-title">Trade Details</div>
                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label for="trade-direction" class="form-label">Trade Direction:</label>
                        <select class="form-select" id="trade-direction" required="">
                            <option value="buy">Buy (Long)</option>
                            <option value="sell">Sell (Short)</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="entry-price" class="form-label">Entry Price:</label>
                        <input type="number" class="form-control" id="entry-price" step="0.00001" placeholder="Current market price">
                        <small class="text-muted">Leave blank to use current market price</small>
                    </div>
                </div>

                <!-- Stop Loss Tab Navigation -->
                <ul class="nav nav-tabs" id="stop-loss-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="sl-pips-tab" data-bs-toggle="tab" data-bs-target="#sl-pips" type="button" role="tab" aria-controls="sl-pips" aria-selected="true">Fixed Pips</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sl-price-tab" data-bs-toggle="tab" data-bs-target="#sl-price" type="button" role="tab" aria-controls="sl-price" aria-selected="false">Price Level</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sl-atr-tab" data-bs-toggle="tab" data-bs-target="#sl-atr" type="button" role="tab" aria-controls="sl-atr" aria-selected="false">ATR-Based</button>
                    </li>
                </ul>

                <!-- Stop Loss Tab Content -->
                <div class="tab-content" id="stop-loss-tab-content">
                    <!-- Fixed Pips Tab -->
                    <div class="tab-pane fade show active" id="sl-pips" role="tabpanel" aria-labelledby="sl-pips-tab">
                        <div class="row mb-3 mt-3">
                            <div class="col-md-12">
                                <label for="stop-loss-pips" class="form-label">Stop Loss (in pips):</label>
                                <input type="number" class="form-control" id="stop-loss-pips" min="0.1" step="0.1" value="50">
                                <small class="text-muted">Distance from entry in pips (e.g., 57.2)</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Level Tab -->
                    <div class="tab-pane fade" id="sl-price" role="tabpanel" aria-labelledby="sl-price-tab">
                        <div class="row mb-3 mt-3">
                            <div class="col-md-12">
                                <label for="stop-loss-price" class="form-label">Stop Loss Price:</label>
                                <input type="number" class="form-control" id="stop-loss-price" step="0.00001" placeholder="Stop loss price">
                                <small class="text-muted">Exact price level for stop loss</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ATR-Based Tab -->
                    <div class="tab-pane fade" id="sl-atr" role="tabpanel" aria-labelledby="sl-atr-tab">
                        <div class="row mb-3 mt-3">
                            <div class="col-md-12">
                                <p>Using ATR-based stop loss: <span id="atr-sl-value" class="fw-bold">- pips</span></p>
                                <p class="text-muted small">Stop loss is calculated as: Current ATR × ATR Multiplier</p>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="update-atr-sl-btn">
                                    Recalculate ATR Stop Loss
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Take Profit Tab Navigation -->
                <ul class="nav nav-tabs mt-4" id="take-profit-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tp-price-tab" data-bs-toggle="tab" data-bs-target="#tp-price" type="button" role="tab" aria-controls="tp-price" aria-selected="true">TP by Price/Pips</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tp-ratio-tab" data-bs-toggle="tab" data-bs-target="#tp-ratio" type="button" role="tab" aria-controls="tp-ratio" aria-selected="false">TP by Risk-Reward</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tp-atr-tab" data-bs-toggle="tab" data-bs-target="#tp-atr" type="button" role="tab" aria-controls="tp-atr" aria-selected="false">ATR-Based</button>
                    </li>
                </ul>

                <!-- Take Profit Tab Content -->
                <div class="tab-content" id="take-profit-tab-content">
                    <!-- Price/Pips Tab -->
                    <div class="tab-pane fade show active" id="tp-price" role="tabpanel" aria-labelledby="tp-price-tab">
                        <div class="row mb-3 mt-3">
                            <div class="col-md-6 mb-3">
                                <label for="take-profit-price" class="form-label">Take Profit Price:</label>
                                <input type="number" class="form-control" id="take-profit-price" step="0.00001" placeholder="Take profit price">
                                <small class="text-muted">Or use pips below</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="take-profit-pips" class="form-label">Take Profit (in pips):</label>
                                <input type="number" class="form-control" id="take-profit-pips" min="0.1" step="0.1" placeholder="e.g., 100">
                                <small class="text-muted">Distance from entry in pips (e.g., 114.4)</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk-Reward Tab -->
                    <div class="tab-pane fade" id="tp-ratio" role="tabpanel" aria-labelledby="tp-ratio-tab">
                        <div class="row mb-3 mt-3">
                            <div class="col-md-6 mb-3">
                                <label for="risk-reward-ratio" class="form-label">Risk-to-Reward Ratio:</label>
                                <div class="input-group">
                                    <span class="input-group-text">1:</span>
                                    <input type="number" class="form-control" id="risk-reward-ratio-input" min="0.1" step="0.1" value="2">
                                </div>
                                <small class="text-muted">Enter reward value (e.g., 2 for 1:2)</small>
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <button type="button" class="btn btn-secondary" id="calculate-tp-btn">Calculate Take Profit</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ATR-Based Tab -->
                    <div class="tab-pane fade" id="tp-atr" role="tabpanel" aria-labelledby="tp-atr-tab">
                        <div class="row mb-3 mt-3">
                            <div class="col-md-6 mb-3">
                                <label for="tp-atr-multiplier" class="form-label">TP ATR Multiplier:</label>
                                <input type="number" class="form-control" id="tp-atr-multiplier" min="0.1" step="0.1" value="3">
                                <small class="text-muted">Typically 1.5-3× the ATR multiplier for stop loss</small>
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <button type="button" class="btn btn-secondary" id="calculate-tp-atr-btn">Apply ATR Take Profit</button>
                            </div>
                        </div>
                        <p class="text-muted small">Take profit will be set at: Entry Price ± (ATR × TP ATR Multiplier)</p>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">Position Size Settings</div>
                <div class="mb-3">
                    <label class="form-label">Lot Size Preference:</label>
                    <div class="lot-selector">
                        <div class="lot-option active" data-lot-type="standard">Standard (100,000)</div>
                        <div class="lot-option" data-lot-type="mini">Mini (10,000)</div>
                        <div class="lot-option" data-lot-type="micro">Micro (1,000)</div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="calculate-btn">Calculate Position Size</button>
            </div>
        </form>

        <div class="result-box" id="result-container" style="display: none;">
            <h3 class="result-title">Calculation Results</h3>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <p>Position Size (Lots)</p>
                    <div class="result-value" id="position-size-lots">0.00</div>
                </div>
                <div class="col-md-6 mb-3">
                    <p>Position Size (Units)</p>
                    <div class="result-value" id="position-size-units">0</div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <p>Risk Amount</p>
                    <div class="result-value" id="risk-amount">$0.00</div>
                </div>
                <div class="col-md-6 mb-3">
                    <p>Pip Value</p>
                    <div class="result-value" id="pip-value">$0.00</div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <p>Stop Loss Distance</p>
                    <div class="result-value" id="stop-loss-distance">0 pips</div>
                </div>
                <div class="col-md-6 mb-3">
                    <p>Take Profit Distance</p>
                    <div class="result-value" id="take-profit-distance">0 pips</div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <p>Risk-to-Reward Ratio</p>
                    <div id="risk-reward-ratio-display">-</div>
                </div>
                <div class="col-md-6 mb-3">
                    <p>Potential Profit</p>
                    <div class="result-value profit-indicator" id="potential-profit">$0.00</div>
                </div>
            </div>
            
            <div class="debug-info" id="debug-info">
                <button type="button" class="debug-toggle-btn" id="debug-toggle-btn">
                    <i class="bi bi-chevron-down"></i> Show Debug Information
                </button>
                <div class="debug-content" id="debug-content-wrapper">
                    <h5>Debug Information</h5>
                    <div id="debug-content"></div>
                </div>
            </div>
            
            <button type="button" class="toggle-logs-btn" id="toggle-logs-btn">Show Activity Logs</button>
            <div class="log-container" id="log-container" style="display: none;">
                <div id="log-entries"></div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="settingsModalLabel">
                            <i class="bi bi-gear-fill me-2"></i>Calculator Settings
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Data Source Configuration -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-cloud-arrow-down me-2"></i>Data Source Configuration
                            </h6>
                            
                            <!-- MetaAPI Configuration Section -->
                            <div id="metaapi-config" class="form-section" style="background-color: #e8f5e9; border-left: 3px solid #4caf50;">
                                <div class="form-section-title">MetaAPI Configuration <span class="badge-info">Live Data</span></div>
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-3">
                                        <label for="metaapi-key" class="form-label">MetaAPI Key:</label>
                                        <input type="password" class="form-control" id="metaapi-key" placeholder="Enter your MetaAPI key">
                                        <small class="text-muted">Your MetaAPI authentication key</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="metaapi-account" class="form-label">Account ID:</label>
                                        <input type="text" class="form-control" id="metaapi-account" placeholder="Enter your account ID">
                                        <small class="text-muted">Your MetaTrader account ID</small>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-3">
                                        <label for="metaapi-region" class="form-label">Region:</label>
                                        <select class="form-select" id="metaapi-region">
                                            <option value="new-york">New York</option>
                                            <option value="london">London</option>
                                            <option value="singapore">Singapore</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3 d-flex align-items-end">
                                        <button type="button" class="btn btn-success me-2" id="metaapi-connect-btn">
                                            <i class="bi bi-plug"></i> Initialize MetaAPI
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="clear-credentials-btn">
                                            <i class="bi bi-trash"></i> Clear Saved
                                        </button>
                                    </div>
                                </div>
                                <div id="metaapi-status" class="alert alert-info" style="display: none;">
                                    <i class="bi bi-info-circle"></i> <span id="metaapi-status-text">Ready for on-demand data fetching</span>
                                </div>
                            </div>

                            <!-- Manual Data Input Section -->
                            <div id="manual-data-section" class="form-section mt-3" style="background-color: #fff3cd; border-left: 3px solid #ffc107;">
                                <div class="form-section-title">Manual Data Entry <span class="badge" style="background-color: #ffc107; color: #000;">Offline Mode</span></div>
                                <p class="text-warning mb-3">
                                    <i class="bi bi-exclamation-triangle"></i> 
                                    API connection unavailable. Please enter market data manually for accurate calculations.
                                </p>
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-current-price" class="form-label">Current Market Price:</label>
                                        <input type="number" class="form-control" id="manual-current-price" step="0.00001" placeholder="Enter current price">
                                        <small class="text-muted">Current market price for the selected pair</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="manual-atr-value" class="form-label">ATR Value:</label>
                                        <input type="number" class="form-control" id="manual-atr-value" step="0.00001" placeholder="Enter ATR value">
                                        <small class="text-muted">Average True Range for the selected timeframe</small>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <button type="button" class="btn btn-warning" id="apply-manual-data-btn">
                                            <i class="bi bi-check-circle"></i> Apply Manual Data
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary ms-2" id="retry-api-connection-btn">
                                            <i class="bi bi-arrow-clockwise"></i> Retry API Connection
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Settings Section -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-person-circle me-2"></i>Account Settings
                            </h6>
                            <div class="form-section">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="settings-account-size" class="form-label">Account Size:</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="settings-account-size" min="1" step="1" value="10000">
                                            <span class="input-group-text" id="settings-account-currency-symbol">USD</span>
                                        </div>
                                        <small class="text-muted">Your trading account balance</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="settings-risk-percentage" class="form-label">Risk Percentage:</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="settings-risk-percentage" min="0.1" max="100" step="0.1" value="2">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <small class="text-muted">Percentage of account to risk per trade</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="settings-account-currency" class="form-label">Account Currency:</label>
                                        <select class="form-select" id="settings-account-currency">
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                            <option value="JPY">JPY</option>
                                            <option value="AUD">AUD</option>
                                            <option value="CAD">CAD</option>
                                            <option value="CHF">CHF</option>
                                            <option value="NZD">NZD</option>
                                        </select>
                                        <small class="text-muted">Currency of your trading account</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="settings-default-lot-size" class="form-label">Default Lot Size:</label>
                                        <select class="form-select" id="settings-default-lot-size">
                                            <option value="standard">Standard (100,000)</option>
                                            <option value="mini">Mini (10,000)</option>
                                            <option value="micro">Micro (1,000)</option>
                                        </select>
                                        <small class="text-muted">Preferred lot size for calculations</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Settings Sections -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-sliders me-2"></i>Calculator Preferences
                            </h6>
                            <div class="form-section">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="default-risk-percentage" class="form-label">Default Risk Percentage:</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="default-risk-percentage" min="0.1" max="100" step="0.1" value="2">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <small class="text-muted">Default risk percentage for new calculations</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="default-atr-periods" class="form-label">Default ATR Periods:</label>
                                        <select class="form-select" id="default-atr-periods">
                                            <option value="14">14 periods (standard)</option>
                                            <option value="20">20 periods</option>
                                            <option value="10">10 periods</option>
                                            <option value="5">5 periods</option>
                                        </select>
                                        <small class="text-muted">Default ATR calculation period</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="settings-global-timeframe" class="form-label">Default Timeframe:</label>
                                        <select class="form-select" id="settings-global-timeframe">
                                            <option value="1m">1 minute</option>
                                            <option value="5m">5 minutes</option>
                                            <option value="15m">15 minutes</option>
                                            <option value="30m">30 minutes</option>
                                            <option value="1h">1 hour</option>
                                            <option value="4h" selected>4 hours</option>
                                            <option value="8h">8 hours</option>
                                            <option value="1d">Daily</option>
                                        </select>
                                        <small class="text-muted">Default timeframe for ATR and analysis</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="settings-default-sl-multiplier" class="form-label">Default SL Multiplier:</label>
                                        <input type="number" class="form-control" id="settings-default-sl-multiplier" min="0.1" step="0.1" value="2.0">
                                        <small class="text-muted">Default ATR multiplier for stop loss calculations</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="settings-default-tp-ratio" class="form-label">Default TP Ratio:</label>
                                        <input type="number" class="form-control" id="settings-default-tp-ratio" min="0.1" step="0.1" value="2.0">
                                        <small class="text-muted">Default risk-to-reward ratio for take profit</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="settings-use-thousand-separators">
                                            <label class="form-check-label" for="settings-use-thousand-separators">
                                                Use Thousand Separators
                                            </label>
                                            <small class="form-text text-muted d-block">Add commas to separate thousands in numeric displays (e.g., 10,000 instead of 10000)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" id="reset-settings-btn">
                            <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="save-settings-btn">
                            <i class="bi bi-check-lg"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="disclaimer">
            <p><strong>HIGH RISK WARNING:</strong> Foreign exchange trading carries a high level of risk that may not be suitable for all investors. Leverage creates additional risk and loss exposure. Before you decide to trade foreign exchange, carefully consider your investment objectives, experience level, and risk tolerance. You could lose some or all of your initial investment. Do not invest money that you cannot afford to lose.</p>
            <p>Exchange rates are provided by <span id="api-name-footer">MetaAPI (Real-time)</span>. Last updated: <span id="api-update-time">-</span></p>
            
            <!-- Footer -->
            <div class="border-top pt-3 mt-3">
                <div class="row align-items-center">
                    <div class="col-md-6 text-center text-md-start mb-2 mb-md-0">
                        <span class="text-muted">Forex-PSC Powered by </span>
                        <a href="https://remoratrader.com" target="_blank" class="text-decoration-none fw-bold text-primary">
                            RemoraTrader.com
                        </a>
                    </div>
                    <div class="col-md-6 text-center text-md-end">
                        <a href="https://github.com/lfontanez/forex-psc" target="_blank" class="text-decoration-none text-muted">
                            <i class="bi bi-github me-1"></i>
                            lfontanez/forex-psc
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>
    <script src="calculator.js"></script>
    <script>
        $(document).ready(function() {
            // Settings Manager - Comprehensive localStorage management
            const settingsManager = {
                defaultSettings: {
                    // MetaAPI Configuration
                    metaapi_key: '',
                    metaapi_account: '',
                    metaapi_region: 'new-york',
                    
                    // Account Settings
                    account_size: 10000,
                    risk_percentage: 2,
                    account_currency: 'USD',
                    
                    // Calculator Preferences
                    default_atr_periods: 14,
                    default_lot_size: 'standard',
                    global_timeframe: '4h',
                    default_sl_multiplier: 2.0,
                    default_tp_ratio: 2.0,
                    
                    // UI Preferences
                    auto_initialize_metaapi: true,
                    show_debug_info: true,
                    use_thousand_separators: false
                },
                
                // Load all settings from localStorage
                loadSettings: function() {
                    const settings = { ...this.defaultSettings };
                    
                    // Load each setting from localStorage
                    Object.keys(settings).forEach(key => {
                        const stored = localStorage.getItem(`forex_calc_${key}`);
                        if (stored !== null) {
                            // Parse numbers and booleans appropriately
                            if (key === 'account_size' || key === 'risk_percentage' || key === 'default_atr_periods' || key === 'default_sl_multiplier' || key === 'default_tp_ratio') {
                                settings[key] = parseFloat(stored);
                            } else if (key === 'auto_initialize_metaapi' || key === 'show_debug_info' || key === 'use_thousand_separators') {
                                settings[key] = stored === 'true';
                            } else {
                                settings[key] = stored;
                            }
                        }
                    });
                    
                    logger.logCalculation('SETTINGS_LOADED', {}, settings);
                    return settings;
                },
                
                // Save a single setting to localStorage
                saveSetting: function(key, value) {
                    localStorage.setItem(`forex_calc_${key}`, value.toString());
                    logger.logCalculation('SETTING_SAVED', { key, value });
                },
                
                // Save all settings to localStorage
                saveAllSettings: function(settings) {
                    Object.keys(settings).forEach(key => {
                        this.saveSetting(key, settings[key]);
                    });
                    logger.logCalculation('ALL_SETTINGS_SAVED', {}, settings);
                },
                
                // Apply settings to UI elements
                applySettingsToUI: function(settings) {
                    // MetaAPI Settings
                    $('#metaapi-key').val(settings.metaapi_key);
                    $('#metaapi-account').val(settings.metaapi_account);
                    $('#metaapi-region').val(settings.metaapi_region);
                    
                    // Account Settings (now in settings modal)
                    $('#account-size').val(settings.account_size);
                    $('#risk-percentage').val(settings.risk_percentage);
                    $('#account-currency').val(settings.account_currency);
                    $('#settings-account-size').val(settings.account_size);
                    $('#settings-risk-percentage').val(settings.risk_percentage);
                    $('#settings-account-currency').val(settings.account_currency);
                    
                    // Update global useThousandSeparators variable
                    useThousandSeparators = settings.use_thousand_separators;
                    
                    // Calculator Preferences
                    $('#atr-periods').val(settings.default_atr_periods);
                    $('#default-atr-periods').val(settings.default_atr_periods);
                    $('#default-risk-percentage').val(settings.risk_percentage);
                    $('#atr-multiplier').val(settings.default_sl_multiplier);
                    $('#risk-reward-ratio-input').val(settings.default_tp_ratio);
                    $('#settings-default-sl-multiplier').val(settings.default_sl_multiplier);
                    $('#settings-default-tp-ratio').val(settings.default_tp_ratio);
                    
                    // Lot Size Selection
                    $('.lot-option').removeClass('active');
                    $(`.lot-option[data-lot-type="${settings.default_lot_size}"]`).addClass('active');
                    selectedLotSize = settings.default_lot_size;
                    
                    // Global Timeframe
                    $('.timeframe-option').removeClass('active');
                    $(`.timeframe-option[data-timeframe="${settings.global_timeframe}"]`).addClass('active');
                    globalTimeframe = settings.global_timeframe;
                    $('#settings-global-timeframe').val(settings.global_timeframe);
                    
                    // Update account currency symbols
                    const currencySymbol = getCurrencySymbol(settings.account_currency);
                    $('.account-currency-symbol').text(currencySymbol);
                    $('#settings-account-currency-symbol').text(currencySymbol);
                    
                    // UI Preferences
                    $('#settings-use-thousand-separators').prop('checked', settings.use_thousand_separators);
                    
                    logger.logCalculation('SETTINGS_APPLIED_TO_UI', {}, settings);
                },
                
                // Collect current settings from UI
                collectSettingsFromUI: function() {
                    return {
                        // MetaAPI Configuration
                        metaapi_key: $('#metaapi-key').val(),
                        metaapi_account: $('#metaapi-account').val(),
                        metaapi_region: $('#metaapi-region').val(),
                        
                        // Account Settings
                        account_size: parseFloat($('#settings-account-size').val()) || this.defaultSettings.account_size,
                        risk_percentage: parseFloat($('#settings-risk-percentage').val()) || this.defaultSettings.risk_percentage,
                        account_currency: $('#settings-account-currency').val() || this.defaultSettings.account_currency,
                        
                        // Calculator Preferences
                        default_atr_periods: parseInt($('#default-atr-periods').val()) || this.defaultSettings.default_atr_periods,
                        default_lot_size: selectedLotSize || this.defaultSettings.default_lot_size,
                        global_timeframe: $('#settings-global-timeframe').val() || this.defaultSettings.global_timeframe,
                        default_sl_multiplier: parseFloat($('#settings-default-sl-multiplier').val()) || this.defaultSettings.default_sl_multiplier,
                        default_tp_ratio: parseFloat($('#settings-default-tp-ratio').val()) || this.defaultSettings.default_tp_ratio,
                        
                        // UI Preferences
                        auto_initialize_metaapi: true, // Always true for now
                        show_debug_info: true, // Always true for now
                        use_thousand_separators: $('#settings-use-thousand-separators').is(':checked')
                    };
                },
                
                // Reset all settings to defaults
                resetToDefaults: function() {
                    // Clear localStorage
                    Object.keys(this.defaultSettings).forEach(key => {
                        localStorage.removeItem(`forex_calc_${key}`);
                    });
                    
                    // Apply defaults to UI
                    this.applySettingsToUI(this.defaultSettings);
                    
                    logger.logCalculation('SETTINGS_RESET_TO_DEFAULTS', {});
                    return this.defaultSettings;
                }
            };
            
            // MetaAPI Status Manager
            const metaAPIStatusManager = {
                states: {
                    DISCONNECTED: 'disconnected',
                    CONNECTING: 'connecting', 
                    CONNECTED: 'connected'
                },
                
                currentState: 'disconnected',
                
                // Update status icon and visibility
                updateStatus: function(state, message = '') {
                    this.currentState = state;
                    const $icon = $('#metaapi-status-icon');
                    const $statusText = $('#metaapi-status-text');
                    
                    // Remove all state classes
                    $icon.removeClass('connected disconnected connecting');
                    
                    // Show/hide icon based on state
                    if (state === this.states.DISCONNECTED) {
                        $icon.hide();
                    } else {
                        $icon.show().addClass(state);
                    }
                    
                    // Update tooltip
                    let tooltip = 'MetaAPI Status: ';
                    switch (state) {
                        case this.states.CONNECTED:
                            tooltip += 'Connected';
                            break;
                        case this.states.CONNECTING:
                            tooltip += 'Connecting...';
                            break;
                        case this.states.DISCONNECTED:
                            tooltip += 'Disconnected';
                            break;
                    }
                    
                    if (message) {
                        tooltip += ` - ${message}`;
                    }
                    
                    $icon.attr('title', tooltip);
                    
                    // Update status text in modal if provided
                    if (message && $statusText.length) {
                        $statusText.text(message);
                    }
                    
                    logger.logCalculation('METAAPI_STATUS_UPDATED', { state, message });
                },
                
                // Set connected state
                setConnected: function(message = 'Connected to MetaAPI') {
                    this.updateStatus(this.states.CONNECTED, message);
                },
                
                // Set connecting state
                setConnecting: function(message = 'Connecting to MetaAPI...') {
                    this.updateStatus(this.states.CONNECTING, message);
                },
                
                // Set disconnected state
                setDisconnected: function(message = 'Not connected') {
                    this.updateStatus(this.states.DISCONNECTED, message);
                }
            };

            // Logger function for tracking API calls and calculations
            const logger = {
                entries: [],
                maxEntries: 200,
                
                // Log API call
                logApi: function(action, payload, response = null) {
                    const entry = {
                        type: 'api',
                        timestamp: new Date(),
                        action: action,
                        payload: payload,
                        response: response
                    };
                    this.addEntry(entry);
                    console.log(`API ${action}:`, { payload, response });
                },
                
                // Log calculation
                logCalculation: function(action, inputs, outputs) {
                    const entry = {
                        type: 'calculation',
                        timestamp: new Date(),
                        action: action,
                        inputs: inputs,
                        outputs: outputs
                    };
                    this.addEntry(entry);
                    console.log(`CALC ${action}:`, { inputs, outputs });
                },
                
                // Log error
                logError: function(action, error, context = null) {
                    const entry = {
                        type: 'error',
                        timestamp: new Date(),
                        action: action,
                        error: error,
                        context: context
                    };
                    this.addEntry(entry);
                    console.error(`ERROR ${action}:`, error, context);
                },
                
                // Add entry to log
                addEntry: function(entry) {
                    this.entries.unshift(entry); // Add to beginning
                    if (this.entries.length > this.maxEntries) {
                        this.entries.pop(); // Remove oldest if exceeding max
                    }
                    this.updateDisplay();
                },
                
                // Update the log display
                updateDisplay: function() {
                    const $logEntries = $('#log-entries');
                    $logEntries.empty();
                    
                    this.entries.forEach(entry => {
                        const time = entry.timestamp.toLocaleTimeString();
                        let html = `<div class="log-entry ${entry.type}">`;
                        html += `<span class="log-timestamp">[${time}]</span>`;
                        
                        if (entry.type === 'api') {
                            html += `<strong>API ${entry.action}</strong>: `;
                            html += `<span>Payload: ${JSON.stringify(entry.payload)}</span>`;
                            if (entry.response) {
                                html += `<br><span>Response: ${JSON.stringify(entry.response).substring(0, 200)}...</span>`;
                            }
                        } else if (entry.type === 'calculation') {
                            html += `<strong>CALC ${entry.action}</strong>: `;
                            html += `<span>Inputs: ${JSON.stringify(entry.inputs)}</span>`;
                            html += `<br><span>Outputs: ${JSON.stringify(entry.outputs)}</span>`;
                        } else if (entry.type === 'error') {
                            html += `<strong>ERROR ${entry.action}</strong>: `;
                            html += `<span>${entry.error}</span>`;
                            if (entry.context) {
                                html += `<br><span>Context: ${JSON.stringify(entry.context)}</span>`;
                            }
                        }
                        
                        html += `</div>`;
                        $logEntries.append(html);
                    });
                },
                
                // Clear all logs
                clear: function() {
                    this.entries = [];
                    this.updateDisplay();
                }
            };
            
            // Toggle logs button
            $('#toggle-logs-btn').click(function() {
                const $logContainer = $('#log-container');
                const isVisible = $logContainer.is(':visible');
                
                if (isVisible) {
                    $logContainer.hide();
                    $(this).text('Show Activity Logs');
                } else {
                    $logContainer.show();
                    $(this).text('Hide Activity Logs');
                }
            });
            
            // Toggle debug info button
            $('#debug-toggle-btn').click(function() {
                const $debugContent = $('#debug-content-wrapper');
                const $icon = $(this).find('i');
                const isVisible = $debugContent.is(':visible');
                
                if (isVisible) {
                    $debugContent.hide();
                    $icon.removeClass('bi-chevron-up').addClass('bi-chevron-down');
                    $(this).html('<i class="bi bi-chevron-down"></i> Show Debug Information');
                } else {
                    $debugContent.show();
                    $icon.removeClass('bi-chevron-down').addClass('bi-chevron-up');
                    $(this).html('<i class="bi bi-chevron-up"></i> Hide Debug Information');
                }
            });
            
            // Selected API (MetaAPI only)
            let selectedApi = 'metaapi';
            
            // MetaAPI initialization status
            let metaAPIInitialized = false;
            
            // Store forex rates
            let forexRates = {};
            let lastUpdateTime = null;
            
            // Store available symbols
            let availableSymbols = [];
            let symbolsFromAPI = false;
            
            // Selected lot size type
            let selectedLotSize = 'standard';
            
            // ATR value
            let currentATR = 0;
            
            // Global timeframe
            let globalTimeframe = '4h';
            
            // Thousand separators preference
            let useThousandSeparators = false;
            
            // Timeframe conversion factors for ATR (relative to daily timeframe)
            const timeframeFactors = {
                '1m': 0.05,   // 1 minute is roughly 5% of daily ATR
                '5m': 0.12,   // 5 minutes is roughly 12% of daily ATR
                '15m': 0.22,  // 15 minutes is roughly 22% of daily ATR
                '30m': 0.32,  // 30 minutes is roughly 32% of daily ATR
                '1h': 0.45,   // 1 hour is roughly 45% of daily ATR
                '4h': 0.67,   // 4 hours is roughly 67% of daily ATR
                '8h': 0.82,   // 8 hours is roughly 82% of daily ATR
                '1d': 1.0     // Daily is the reference (100%)
            };
            
            // Default symbol list (fallback when API not available)
            const defaultSymbols = [
                'EURUSD', 'GBPUSD', 'USDJPY', 'AUDUSD', 'USDCAD', 'USDCHF', 'NZDUSD',
                'EURJPY', 'GBPJPY', 'EURGBP', 'AUDJPY', 'EURAUD', 'GBPAUD', 'XAUUSD'
            ];
            
            // Default ATR values by currency pair (fallback when API not available)
            // These are daily ATR values that will be scaled according to timeframe
            const defaultDailyATRValues = {
                "EURUSD": 0.00120,
                "GBPUSD": 0.00165,
                "USDJPY": 1.420,
                "AUDUSD": 0.00105,
                "USDCAD": 0.00125,
                "USDCHF": 0.00115,
                "NZDUSD": 0.00095,
                "EURJPY": 1.650,
                "GBPJPY": 2.150,
                "EURGBP": 0.00085,
                "AUDJPY": 1.250,
                "EURAUD": 0.00180,
                "GBPAUD": 0.00225,
                "XAUUSD": 30.00
            };
            
            // Lot size values
            const lotSizes = {
                'standard': 100000,
                'mini': 10000,
                'micro': 1000
            };
            
            // Fallback rates in case API fails
            const fallbackRates = {
                "EURUSD": 1.15403,
                "GBPUSD": 1.35613,
                "USDJPY": 143.972,
                "AUDUSD": 0.649,
                "USDCAD": 1.35934,
                "USDCHF": 0.81158,
                "NZDUSD": 0.6142,
                "EURJPY": 166.1498,
                "GBPJPY": 195.2473,
                "EURGBP": 0.8509,
                "AUDJPY": 93.4378,
                "EURAUD": 1.7782,
                "GBPAUD": 2.0895,
                "XAUUSD": 2450.00
            };

            // Conversion rates to USD (fallback when MetaAPI unavailable)
            const usdConversionRates = {
                "USD": 1.0,
                "EUR": 1.15403,
                "GBP": 1.35613,
                "JPY": 0.00694,
                "AUD": 0.649,
                "CAD": 0.73565,
                "CHF": 1.2322,
                "NZD": 0.6142
            };

            // Timeframe selector
            $('.timeframe-option').click(function() {
                $('.timeframe-option').removeClass('active');
                $(this).addClass('active');
                
                const newTimeframe = $(this).data('timeframe');
                const oldTimeframe = globalTimeframe;
                globalTimeframe = newTimeframe;
                
                logger.logCalculation('GLOBAL_TIMEFRAME_CHANGED', { oldTimeframe, newTimeframe });
                
                // Update the ATR timeframe display
                const timeframeText = $(this).text();
                $('#atr-timeframe-display').text(timeframeText + ' timeframe');
                
                // Automatically fetch ATR for the new timeframe
                const currencyPair = $('#currency-pair').val();
                if (currencyPair) {
                    const periods = $('#atr-periods').val();
                    logger.logApi('AUTO_FETCH_ATR_TIMEFRAME_CHANGED', { currencyPair, oldTimeframe, newTimeframe, periods });
                    fetchATR(currencyPair, globalTimeframe, periods);
                }
            });

            // Function to rescale ATR when timeframe changes
            function rescaleATRForTimeframeChange(currentATRValue, fromTimeframe, toTimeframe) {
                // Calculate ratio between timeframes
                const fromFactor = timeframeFactors[fromTimeframe];
                const toFactor = timeframeFactors[toTimeframe];
                const scalingRatio = toFactor / fromFactor;
                
                logger.logCalculation('RESCALE_ATR_FACTORS', 
                    { fromTimeframe, toTimeframe, fromFactor, toFactor }, 
                    { scalingRatio }
                );
                
                // Apply scaling
                return currentATRValue * scalingRatio;
            }

            
            // Function to fetch symbols from MetaAPI and populate dropdown
            async function fetchAndPopulateSymbols() {
                if (!metaAPIInitialized) {
                    logger.logApi('FETCH_SYMBOLS_SKIPPED', { reason: 'MetaAPI not initialized' });
                    return;
                }
                
                try {
                    // Show loading state
                    $('#symbols-status').text('Loading symbols from MetaAPI...');
                    logger.logApi('FETCH_SYMBOLS_STARTED', {});
                    
                    // Fetch symbols from MetaAPI
                    const symbols = await metaAPIService.getSymbols();
                    
                    logger.logApi('FETCH_SYMBOLS_SUCCESS', {}, { symbolCount: symbols.length, symbols: symbols.slice(0, 10) });
                    
                    // Store symbols
                    availableSymbols = symbols;
                    symbolsFromAPI = true;
                    
                    // Populate dropdown
                    populateSymbolDropdown(symbols);
                    
                    // Update status
                    $('#symbols-status').text(`${symbols.length} symbols loaded from MetaAPI`);
                    
                } catch (error) {
                    logger.logError('FETCH_SYMBOLS_FAILED', error.message);
                    
                    // Check if it's a CORS error
                    const isCorsError = error.message.includes('CORS') || 
                                       error.message.includes('Network') || 
                                       error.message.includes('Failed to fetch') || 
                                       error.name === 'TypeError' ||
                                       (error.message && error.message.toLowerCase().includes('cross-origin'));
                    
                    if (isCorsError) {
                        $('#symbols-status').text('CORS blocked - using default symbols');
                        logger.logError('FETCH_SYMBOLS_CORS_ERROR', 'CORS error detected in symbols fetching');
                    } else {
                        $('#symbols-status').text('API error - using default symbols');
                    }
                    
                    // Fall back to default symbols
                    populateSymbolDropdown(defaultSymbols);
                    availableSymbols = defaultSymbols;
                    symbolsFromAPI = false;
                }
            }
            
            // Function to populate symbol dropdown
            function populateSymbolDropdown(symbols) {
                const $dropdown = $('#currency-pair');
                const currentValue = $dropdown.val(); // Preserve current selection
                
                logger.logCalculation('POPULATE_SYMBOL_DROPDOWN_STARTED', { symbolCount: symbols.length, currentValue });
                
                // Clear existing options except the first one
                $dropdown.find('option:not(:first)').remove();
                
                // Add symbols to dropdown
                symbols.forEach(symbol => {
                    // Format symbol for display (add slash for forex pairs)
                    let displayName = symbol;
                    if (symbol.length === 6 && symbol !== 'XAUUSD') {
                        // Standard forex pair - add slash
                        displayName = `${symbol.substring(0, 3)}/${symbol.substring(3, 6)}`;
                    } else if (symbol === 'XAUUSD') {
                        displayName = 'XAU/USD (Gold)';
                    }
                    
                    $dropdown.append(`<option value="${symbol}">${displayName}</option>`);
                });
                
                // Restore previous selection if it still exists
                if (currentValue && symbols.includes(currentValue)) {
                    $dropdown.val(currentValue);
                    logger.logCalculation('SYMBOL_SELECTION_RESTORED', { currentValue });
                }
                
                logger.logCalculation('POPULATE_SYMBOL_DROPDOWN_COMPLETED', { 
                    symbolCount: symbols.length, 
                    finalSelection: $dropdown.val() 
                });
            }
            
            // Function to fetch ATR from MetaAPI
            async function fetchATR(currencyPair, timeframe, periods = '14') {
                // Log the request
                logger.logApi('FETCH_ATR_REQUEST', { currencyPair, timeframe, periods });
                
                let atrValue;
                
                // Try MetaAPI if initialized
                if (metaAPIInitialized) {
                    try {
                        logger.logApi('FETCH_ATR_METAAPI_ATTEMPT', { currencyPair, timeframe, periods });
                        
                        // Get real ATR from MetaAPI
                        atrValue = await metaAPIService.getATR(currencyPair, timeframe, parseInt(periods));
                        
                        logger.logApi('FETCH_ATR_METAAPI_SUCCESS', 
                            { currencyPair, timeframe, periods }, 
                            { atrValue }
                        );
                        
                    } catch (error) {
                        logger.logError('FETCH_ATR_METAAPI_FAILED', error.message, { currencyPair, timeframe, periods });
                        
                        // Check if it's a CORS error
                        const isCorsError = error.message.includes('CORS') || 
                                           error.message.includes('CORS_ERROR') ||
                                           error.message.includes('Network') || 
                                           error.message.includes('Failed to fetch') || 
                                           error.name === 'TypeError' ||
                                           (error.message && error.message.toLowerCase().includes('cross-origin'));
                        
                        if (isCorsError) {
                            logger.logError('FETCH_ATR_CORS_ERROR', 'CORS error detected in ATR fetching', { 
                                error: error.message,
                                currencyPair, timeframe, periods 
                            });
                            
                            // Show manual data section and suggest manual ATR entry
                            showManualDataSection();
                            
                            // Use fallback ATR but inform the user
                            atrValue = getFallbackATR(currencyPair, timeframe, periods);
                            
                            // Update the ATR input field with a placeholder and show a message
                            $('#atr-value').val(atrValue.toFixed(currencyPair.includes('JPY') ? 3 : 5));
                            $('#atr-value').attr('placeholder', 'CORS blocked - using fallback');
                            
                            // Show a message to the user
                            alert('Browser security blocked ATR data fetching. Using fallback ATR values. Please enter ATR manually if needed.');
                        } else {
                            // Fall back to fallback ATR for other errors
                            atrValue = getFallbackATR(currencyPair, timeframe, periods);
                        }
                    }
                } else {
                    // Use fallback ATR when MetaAPI not connected
                    atrValue = getFallbackATR(currencyPair, timeframe, periods);
                }
                
                // Update ATR value input
                $('#atr-value').val(atrValue.toFixed(currencyPair.includes('JPY') ? 3 : 5));
                
                // Store current ATR
                currentATR = atrValue;
                
                // Update ATR-based stop loss
                updateATRStopLoss();
                
                return atrValue;
            }

            // Get fallback ATR when MetaAPI is unavailable
            function getFallbackATR(currencyPair, timeframe, periods) {
                // Get default daily ATR value for the currency pair
                let baseATR = defaultDailyATRValues[currencyPair] || 0.0010;
        
                // Scale the daily ATR to the selected timeframe
                const timeframeFactor = timeframeFactors[timeframe];
                let atrValue = baseATR * timeframeFactor;
        
                // Adjust based on periods (fewer periods typically mean more responsive/higher ATR)
                if (periods === '5') {
                    atrValue *= 1.2; // 5-period ATR is often ~20% higher than 14-period
                } else if (periods === '10') {
                    atrValue *= 1.1; // 10-period ATR is often ~10% higher than 14-period
                } else if (periods === '20') {
                    atrValue *= 0.9; // 20-period ATR is often ~10% lower than 14-period
                }
        
                logger.logApi('FETCH_ATR_FALLBACK', 
                    { currencyPair, timeframe, periods, baseATR, timeframeFactor }, 
                    { atrValue }
                );
        
                return atrValue;
            }
            
            // Update ATR-based stop loss when ATR value or multiplier changes
            $('#atr-value, #atr-multiplier').on('input change', function() {
                updateATRStopLoss();
            });
            
            // Apply ATR to Stop Loss button
            $('#apply-atr-btn').click(function(e) {
                e.preventDefault();
                
                const atrValue = parseFloat($('#atr-value').val());
                const atrMultiplier = parseFloat($('#atr-multiplier').val());
                
                if (isNaN(atrValue) || isNaN(atrMultiplier)) {
                    alert('Please enter valid ATR value and multiplier');
                    logger.logError('APPLY_ATR_TO_SL_FAILED', 'Invalid ATR value or multiplier', { atrValue, atrMultiplier });
                    return;
                }
                
                logger.logCalculation('APPLY_ATR_TO_SL_STARTED', { atrValue, atrMultiplier });
                
                // Calculate ATR-based stop loss in pips
                const currencyPair = $('#currency-pair').val();
                const pipSize = getPipSize(currencyPair);
                
                // Convert ATR to pips
                const atrPips = atrValue / pipSize;
                const slPips = atrPips * atrMultiplier;
                
                logger.logCalculation('APPLY_ATR_TO_SL_CALCULATION', 
                    { atrValue, atrMultiplier, pipSize, atrPips }, 
                    { slPips }
                );
                
                // Update the stop loss pips field with one decimal place
                $('#stop-loss-pips').val(slPips.toFixed(1));
                
                // Trigger change to update stop loss price
                $('#stop-loss-pips').trigger('change');
                
                // Switch to the fixed pips tab
                $('#sl-pips-tab').tab('show');
                
                logger.logCalculation('APPLY_ATR_TO_SL_COMPLETED', { slPips: slPips });
            });
            
            // Update ATR stop loss when recalculate button is clicked
            $('#update-atr-sl-btn').click(function(e) {
                e.preventDefault();
                logger.logCalculation('UPDATE_ATR_SL_BUTTON_CLICKED', {});
                updateATRStopLoss();
                
                // Show the ATR stop loss tab
                $('#sl-atr-tab').tab('show');
            });
            
            // Calculate take profit based on ATR
            $('#calculate-tp-atr-btn').click(function(e) {
                e.preventDefault();
                
                const atrValue = parseFloat($('#atr-value').val());
                const tpAtrMultiplier = parseFloat($('#tp-atr-multiplier').val());
                
                if (isNaN(atrValue) || isNaN(tpAtrMultiplier)) {
                    alert('Please enter valid ATR value and TP multiplier');
                    logger.logError('CALCULATE_TP_ATR_FAILED', 'Invalid ATR value or TP multiplier', { atrValue, tpAtrMultiplier });
                    return;
                }
                
                logger.logCalculation('CALCULATE_TP_ATR_STARTED', { atrValue, tpAtrMultiplier });
                
                // Calculate ATR-based take profit in pips
                const currencyPair = $('#currency-pair').val();
                const pipSize = getPipSize(currencyPair);
                
                // Convert ATR to pips
                const atrPips = atrValue / pipSize;
                const tpPips = atrPips * tpAtrMultiplier;
                
                logger.logCalculation('CALCULATE_TP_ATR_CALCULATION', 
                    { atrValue, tpAtrMultiplier, pipSize, atrPips }, 
                    { tpPips }
                );
                
                // Update the take profit pips field with one decimal place
                $('#take-profit-pips').val(tpPips.toFixed(1));
                
                // Trigger change to update take profit price
                $('#take-profit-pips').trigger('change');
                
                // Switch to the price/pips tab
                $('#tp-price-tab').tab('show');
                
                logger.logCalculation('CALCULATE_TP_ATR_COMPLETED', { tpPips: tpPips });
            });
            
            // Update ATR-based stop loss display
            function updateATRStopLoss() {
                const atrValue = parseFloat($('#atr-value').val());
                const atrMultiplier = parseFloat($('#atr-multiplier').val());
                
                if (isNaN(atrValue) || isNaN(atrMultiplier)) {
                    $('#sl-atr-info, #atr-sl-value').text('- pips');
                    logger.logCalculation('UPDATE_ATR_SL_SKIPPED', { reason: 'Invalid inputs', atrValue, atrMultiplier });
                    return;
                }
                
                logger.logCalculation('UPDATE_ATR_SL_STARTED', { atrValue, atrMultiplier });
                
                // Calculate ATR-based stop loss in pips
                const currencyPair = $('#currency-pair').val();
                const pipSize = getPipSize(currencyPair);
                
                // Convert ATR to pips
                const atrPips = atrValue / pipSize;
                const slPips = atrPips * atrMultiplier;
                
                logger.logCalculation('UPDATE_ATR_SL_CALCULATION', 
                    { atrValue, atrMultiplier, pipSize, atrPips }, 
                    { slPips }
                );
                
                // Update displays with one decimal place
                $('#sl-atr-pips').text(slPips.toFixed(1));
                $('#atr-sl-value').text(slPips.toFixed(1) + ' pips');
                
                // Store for calculations
                currentATR = atrValue;
                
                logger.logCalculation('UPDATE_ATR_SL_COMPLETED', { slPips: slPips.toFixed(1) });
            }

            // Refresh rate button click handler
            $('#refresh-rate-btn').click(function() {
                const currencyPair = $('#currency-pair').val();
                if (currencyPair) {
                    // Save entry price to check if we need to update it
                    const oldEntryPrice = $('#entry-price').val();
                    const useCurrentRateForEntry = !oldEntryPrice;
                    
                    logger.logApi('REFRESH_RATE_CLICKED', { currencyPair, useCurrentRateForEntry });
                    
                    // Refresh the rate
                    fetchForexRate(currencyPair, useCurrentRateForEntry);
                    
                    // Show a brief animation on the button
                    const $btn = $(this);
                    const $icon = $btn.find('i');
                    $icon.addClass('fa-spin');
                    setTimeout(function() {
                        $icon.removeClass('fa-spin');
                    }, 1000);
                } else {
                    alert('Please select a currency pair first');
                    logger.logError('REFRESH_RATE_FAILED', 'No currency pair selected');
                }
            });

            // API selector (MetaAPI only - simplified)
            $('.api-option').click(function() {
                $('.api-option').removeClass('active');
                $(this).addClass('active');
                selectedApi = $(this).data('api');
                
                logger.logApi('API_CHANGED', { newApi: selectedApi });
                
                // MetaAPI configuration is always visible
                $('#metaapi-config').show();
                
                // Refetch currency pair rates if one is selected
                const currencyPair = $('#currency-pair').val();
                if (currencyPair) {
                    const oldEntryPrice = $('#entry-price').val();
                    const useCurrentRateForEntry = !oldEntryPrice;
                    
                    fetchForexRate(currencyPair, useCurrentRateForEntry);
                }
            });

            // MetaAPI Connect button
            $('#metaapi-connect-btn').click(async function() {
                let apiKey = $('#metaapi-key').val().trim();
                let accountId = $('#metaapi-account').val().trim();
                const region = $('#metaapi-region').val();
                    
                // Try to load from config file if fields are empty
                if (!apiKey || !accountId) {
                    try {
                        // For browser context, try to load from a global config object
                        // This would be set by a separate config.js file
                        if (typeof window !== 'undefined' && window.ENV_CONFIG) {
                            apiKey = apiKey || window.ENV_CONFIG.METAAPI_API_KEY;
                            accountId = accountId || window.ENV_CONFIG.METAAPI_ACCOUNT_ID;
                        }
                            
                        // Auto-fill the form fields if we found values
                        if (apiKey && !$('#metaapi-key').val()) {
                            $('#metaapi-key').val(apiKey);
                            logger.logApi('METAAPI_KEY_LOADED_FROM_CONFIG', { source: 'config' });
                        }
                        if (accountId && !$('#metaapi-account').val()) {
                            $('#metaapi-account').val(accountId);
                            logger.logApi('METAAPI_ACCOUNT_LOADED_FROM_CONFIG', { source: 'config' });
                        }
                            
                    } catch (error) {
                        logger.logError('CONFIG_LOAD_FAILED', error.message);
                    }
                }
                    
                if (!apiKey || !accountId) {
                    alert('Please enter both MetaAPI key and Account ID, or ensure they are set in your config.json file');
                    return;
                }
                    
                logger.logApi('METAAPI_CONNECTION_ATTEMPT', { accountId, region });
                    
                // Update UI to show connecting state
                const $btn = $(this);
                $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Connecting...');
                metaAPIStatusManager.setConnecting('Connecting to MetaAPI...');
                $('#metaapi-status').show().removeClass('alert-success alert-danger alert-warning').addClass('alert-info');
                $('#metaapi-status-text').text('Connecting to MetaAPI...');
                    
                try {
                    // Initialize MetaAPI (simple connection, no sync wait)
                    await metaAPIService.initialize(apiKey, accountId, region);
                        
                    // Update UI for successful initialization
                    metaAPIInitialized = true;
                    metaAPIStatusManager.setConnected('Connected successfully');
                    $btn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> MetaAPI Ready');
                    $('#metaapi-status').removeClass('alert-info').addClass('alert-success');
                    $('#metaapi-status-text').html('<i class="bi bi-check-circle"></i> MetaAPI initialized! Data will be fetched on-demand when needed.');
                        
                    logger.logApi('METAAPI_CONNECTION_SUCCESS', { accountId, region });
                    
                    // Save credentials to settings on successful connection
                    settingsManager.saveSetting('metaapi_key', apiKey);
                    settingsManager.saveSetting('metaapi_account', accountId);
                    settingsManager.saveSetting('metaapi_region', region);
                    logger.logApi('METAAPI_CREDENTIALS_SAVED_TO_SETTINGS', { accountId, region });
                    console.log('MetaAPI credentials saved to settings');
                    
                    // Fetch and populate symbols
                    await fetchAndPopulateSymbols();
                        
                    // Refresh current pair if selected
                    const currencyPair = $('#currency-pair').val();
                    if (currencyPair) {
                        fetchForexRate(currencyPair, true);
                    }
                        
                } catch (error) {
                    // Update UI for failed initialization
                    metaAPIInitialized = false;
                    metaAPIStatusManager.setDisconnected('Connection failed');
                    $btn.prop('disabled', false).html('<i class="bi bi-plug"></i> Initialize MetaAPI');
                        
                    $('#metaapi-status').removeClass('alert-info').addClass('alert-danger');
                    $('#metaapi-status-text').html(`<i class="bi bi-exclamation-triangle"></i> Initialization failed: ${error.message}`);
                        
                    logger.logError('METAAPI_CONNECTION_FAILED', error.message, { accountId, region });
                }
            });

            // Clear saved credentials button
            $('#clear-credentials-btn').click(function() {
                try {
                    // Clear from settings
                    settingsManager.saveSetting('metaapi_key', '');
                    settingsManager.saveSetting('metaapi_account', '');
                    settingsManager.saveSetting('metaapi_region', 'new-york');
                    
                    // Clear form fields
                    $('#metaapi-key').val('');
                    $('#metaapi-account').val('');
                    $('#metaapi-region').val('new-york');
                    
                    // Update status
                    metaAPIInitialized = false;
                    metaAPIStatusManager.setDisconnected('Credentials cleared');
                    $('#metaapi-status').show().removeClass('alert-success alert-danger').addClass('alert-warning');
                    $('#metaapi-status-text').html('<i class="bi bi-info-circle"></i> Saved credentials cleared. Please enter new credentials.');
                    
                    // Reset connect button
                    $('#metaapi-connect-btn').prop('disabled', false).html('<i class="bi bi-plug"></i> Initialize MetaAPI');
                    
                    logger.logApi('METAAPI_CREDENTIALS_CLEARED', { source: 'settings' });
                    console.log('MetaAPI credentials cleared from settings');
                    
                    alert('Saved credentials have been cleared.');
                } catch (error) {
                    logger.logError('CLEAR_CREDENTIALS_FAILED', error.message);
                    console.error('Failed to clear credentials:', error);
                    alert('Failed to clear credentials: ' + error.message);
                }
            });

            // No disconnect button needed - connections are per-request

            // Apply manual data button
            $('#apply-manual-data-btn').click(function() {
                const manualPrice = parseFloat($('#manual-current-price').val());
                const manualATR = parseFloat($('#manual-atr-value').val());
                const currencyPair = $('#currency-pair').val();
                
                if (!currencyPair) {
                    alert('Please select a currency pair first');
                    return;
                }
                
                logger.logCalculation('APPLY_MANUAL_DATA_STARTED', { manualPrice, manualATR, currencyPair });
                
                // Apply manual price if provided
                if (!isNaN(manualPrice)) {
                    $('#entry-price').val(manualPrice.toFixed(getPipDecimalPlaces(currencyPair)));
                    
                    // Update rate display
                    const formatted = formatRate(manualPrice, currencyPair);
                    $('#current-rate').text(formatted + ' (Manual)');
                    $('#timestamp').text('Manual entry - ' + new Date().toLocaleTimeString());
                    $('#rate-display').show();
                    
                    // Store rate
                    forexRates[currencyPair] = manualPrice;
                    lastUpdateTime = new Date();
                    
                    logger.logCalculation('MANUAL_PRICE_APPLIED', { manualPrice, formatted });
                }
                
                // Apply manual ATR if provided
                if (!isNaN(manualATR)) {
                    $('#atr-value').val(manualATR.toFixed(currencyPair.includes('JPY') ? 3 : 5));
                    currentATR = manualATR;
                    updateATRStopLoss();
                    
                    logger.logCalculation('MANUAL_ATR_APPLIED', { manualATR });
                }
                
                // Update dependent values
                updateDependentValues();
                
                // Show success message
                if (!isNaN(manualPrice) || !isNaN(manualATR)) {
                    const appliedItems = [];
                    if (!isNaN(manualPrice)) appliedItems.push('price');
                    if (!isNaN(manualATR)) appliedItems.push('ATR');
                    
                    alert(`Manual ${appliedItems.join(' and ')} applied successfully!`);
                    logger.logCalculation('APPLY_MANUAL_DATA_SUCCESS', { appliedItems });
                } else {
                    alert('Please enter at least one value (price or ATR)');
                    logger.logError('APPLY_MANUAL_DATA_ERROR', 'No valid values provided');
                }
            });

            // Retry API connection button
            $('#retry-api-connection-btn').click(function() {
                logger.logApi('RETRY_API_CONNECTION_CLICKED', { selectedApi });
                
                const currencyPair = $('#currency-pair').val();
                if (currencyPair) {
                    // Hide manual data section temporarily
                    $('#manual-data-section').hide();
                    
                    // Try to fetch data again
                    fetchForexRate(currencyPair, true);
                    fetchATR(currencyPair, globalTimeframe, $('#atr-periods').val());
                } else {
                    alert('Please select a currency pair first');
                }
            });

            // Function to show manual data section when APIs fail
            function showManualDataSection() {
                $('#manual-data-section').show();
                logger.logCalculation('MANUAL_DATA_SECTION_SHOWN', { reason: 'API failure' });
            }

            // Function to hide manual data section when APIs work
            function hideManualDataSection() {
                $('#manual-data-section').hide();
                logger.logCalculation('MANUAL_DATA_SECTION_HIDDEN', { reason: 'API success' });
            }

            // Function to show CORS-specific error messaging
            function showCorsError() {
                showManualDataSection();
                
                // Add specific CORS guidance to the manual section
                const corsGuidance = `
                    <div class="alert alert-warning mt-3">
                        <h6><i class="bi bi-exclamation-triangle"></i> CORS Restriction Detected</h6>
                        <p class="mb-1">Your browser is blocking MetaAPI requests due to Cross-Origin Resource Sharing (CORS) policies.</p>
                        <p class="mb-0"><strong>Solution:</strong> Use the manual data entry fields below, or deploy this application to a web server with proper CORS headers.</p>
                    </div>
                `;
                
                // Only add the guidance once
                if (!$('#cors-guidance').length) {
                    $('#manual-data-section').prepend(`<div id="cors-guidance">${corsGuidance}</div>`);
                }
                
                logger.logCalculation('CORS_ERROR_HANDLED', { action: 'showed manual data section with CORS guidance' });
            }

            // Fetch forex rate when currency pair changes
            $('#currency-pair').change(function() {
                const currencyPair = $(this).val();
                if (currencyPair) {
                    logger.logApi('CURRENCY_PAIR_CHANGED', { currencyPair });
                    
                    fetchForexRate(currencyPair, true);
                    
                    // Automatically fetch ATR for the new pair
                    const periods = $('#atr-periods').val();
                    logger.logApi('AUTO_FETCH_ATR_INITIATED', { currencyPair, periods, timeframe: globalTimeframe });
                    fetchATR(currencyPair, globalTimeframe, periods);
                    
                    // Clear entry, stop-loss, and take-profit fields
                    $('#entry-price').val('');
                    $('#stop-loss-price').val('');
                    $('#stop-loss-pips').val('50'); // Reset to default
                    $('#take-profit-price').val('');
                    $('#take-profit-pips').val('');
                    
                    // Update placeholder with appropriate decimal places
                    if (currencyPair.includes('JPY')) {
                        $('#entry-price, #stop-loss-price, #take-profit-price, #atr-value').attr('step', '0.001').attr('placeholder', 'e.g., 143.972');
                    } else if (currencyPair === 'XAUUSD') {
                        $('#entry-price, #stop-loss-price, #take-profit-price, #atr-value').attr('step', '0.01').attr('placeholder', 'e.g., 2450.00');
                    } else {
                        $('#entry-price, #stop-loss-price, #take-profit-price, #atr-value').attr('step', '0.00001').attr('placeholder', 'e.g., 1.15403');
                    }
                } else {
                    $('#rate-display').hide();
                }
            });

            // Update ATR when periods changes
            $('#atr-periods').change(function() {
                const periods = $(this).val();
                logger.logCalculation('ATR_PERIODS_CHANGED', { periods });
                
                const currencyPair = $('#currency-pair').val();
                if (currencyPair) {
                    logger.logApi('AUTO_FETCH_ATR_PERIODS_CHANGED', { currencyPair, periods, timeframe: globalTimeframe });
                    fetchATR(currencyPair, globalTimeframe, periods);
                }
            });

            // Lot size selector
            $('.lot-option').click(function() {
                $('.lot-option').removeClass('active');
                $(this).addClass('active');
                selectedLotSize = $(this).data('lot-type');
                logger.logCalculation('LOT_SIZE_CHANGED', { selectedLotSize });
            });

            // Auto-calculate stop loss price when pips change and entry price is set
            $('#stop-loss-pips, #entry-price, #trade-direction').on('input change', function() {
                const entryPrice = parseFloat($('#entry-price').val());
                const stopLossPips = parseFloat($('#stop-loss-pips').val());
                const tradeDirection = $('#trade-direction').val();
                const currencyPair = $('#currency-pair').val();
                
                if (!isNaN(entryPrice) && !isNaN(stopLossPips) && currencyPair) {
                    logger.logCalculation('CALCULATE_SL_PRICE_FROM_PIPS_STARTED', 
                        { entryPrice, stopLossPips, tradeDirection, currencyPair }
                    );
                    
                    const pipDecimalPlaces = getPipDecimalPlaces(currencyPair);
                    const pipSize = getPipSize(currencyPair);
                    
                    let stopLossPrice;
                    if (tradeDirection === 'buy') {
                        stopLossPrice = entryPrice - (stopLossPips * pipSize);
                    } else {
                        stopLossPrice = entryPrice + (stopLossPips * pipSize);
                    }
                    
                    logger.logCalculation('CALCULATE_SL_PRICE_FROM_PIPS_RESULT', 
                        { pipDecimalPlaces, pipSize },
                        { stopLossPrice }
                    );
                    
                    $('#stop-loss-price').val(stopLossPrice.toFixed(pipDecimalPlaces));
                }
            });

            // Auto-calculate stop loss pips when price changes
            $('#stop-loss-price, #entry-price, #trade-direction').on('input change', function() {
                const entryPrice = parseFloat($('#entry-price').val());
                const stopLossPrice = parseFloat($('#stop-loss-price').val());
                const tradeDirection = $('#trade-direction').val();
                const currencyPair = $('#currency-pair').val();
                
                if (!isNaN(entryPrice) && !isNaN(stopLossPrice) && currencyPair) {
                    logger.logCalculation('CALCULATE_SL_PIPS_FROM_PRICE_STARTED', 
                        { entryPrice, stopLossPrice, tradeDirection, currencyPair }
                    );
                    
                    const pipDecimalPlaces = getPipDecimalPlaces(currencyPair);
                    const pipSize = getPipSize(currencyPair);
                    
                    let stopLossPips;
                    if (tradeDirection === 'buy') {
                        stopLossPips = (entryPrice - stopLossPrice) / pipSize;
                    } else {
                        stopLossPips = (stopLossPrice - entryPrice) / pipSize;
                    }
                    
                    logger.logCalculation('CALCULATE_SL_PIPS_FROM_PRICE_RESULT', 
                        { pipDecimalPlaces, pipSize },
                        { stopLossPips }
                    );
                    
                    // Only update if positive pips and round to integer
                    if (stopLossPips > 0) {
                        $('#stop-loss-pips').val(Math.round(stopLossPips));
                    } else {
                        logger.logError('CALCULATE_SL_PIPS_FROM_PRICE_ERROR', 'Negative pips calculated', { stopLossPips });
                    }
                }
            });

            // Auto-calculate take profit price when pips change and entry price is set
            $('#take-profit-pips, #entry-price, #trade-direction').on('input change', function() {
                const entryPrice = parseFloat($('#entry-price').val());
                const takeProfitPips = parseFloat($('#take-profit-pips').val());
                const tradeDirection = $('#trade-direction').val();
                const currencyPair = $('#currency-pair').val();
                
                if (!isNaN(entryPrice) && !isNaN(takeProfitPips) && currencyPair) {
                    logger.logCalculation('CALCULATE_TP_PRICE_FROM_PIPS_STARTED', 
                        { entryPrice, takeProfitPips, tradeDirection, currencyPair }
                    );
                    
                    const pipDecimalPlaces = getPipDecimalPlaces(currencyPair);
                    const pipSize = getPipSize(currencyPair);
                    
                    let takeProfitPrice;
                    if (tradeDirection === 'buy') {
                        takeProfitPrice = entryPrice + (takeProfitPips * pipSize);
                    } else {
                        takeProfitPrice = entryPrice - (takeProfitPips * pipSize);
                    }
                    
                    logger.logCalculation('CALCULATE_TP_PRICE_FROM_PIPS_RESULT', 
                        { pipDecimalPlaces, pipSize },
                        { takeProfitPrice }
                    );
                    
                    $('#take-profit-price').val(takeProfitPrice.toFixed(pipDecimalPlaces));
                }
            });

            // Auto-calculate take profit pips when price changes
            $('#take-profit-price, #entry-price, #trade-direction').on('input change', function() {
                const entryPrice = parseFloat($('#entry-price').val());
                const takeProfitPrice = parseFloat($('#take-profit-price').val());
                const tradeDirection = $('#trade-direction').val();
                const currencyPair = $('#currency-pair').val();
                
                if (!isNaN(entryPrice) && !isNaN(takeProfitPrice) && currencyPair) {
                    logger.logCalculation('CALCULATE_TP_PIPS_FROM_PRICE_STARTED', 
                        { entryPrice, takeProfitPrice, tradeDirection, currencyPair }
                    );
                    
                    const pipDecimalPlaces = getPipDecimalPlaces(currencyPair);
                    const pipSize = getPipSize(currencyPair);
                    
                    let takeProfitPips;
                    if (tradeDirection === 'buy') {
                        takeProfitPips = (takeProfitPrice - entryPrice) / pipSize;
                    } else {
                        takeProfitPips = (entryPrice - takeProfitPrice) / pipSize;
                    }
                    
                    logger.logCalculation('CALCULATE_TP_PIPS_FROM_PRICE_RESULT', 
                        { pipDecimalPlaces, pipSize },
                        { takeProfitPips }
                    );
                    
                    // Only update if positive pips and round to integer
                    if (takeProfitPips > 0) {
                        $('#take-profit-pips').val(Math.round(takeProfitPips));
                    } else {
                        logger.logError('CALCULATE_TP_PIPS_FROM_PRICE_ERROR', 'Negative pips calculated', { takeProfitPips });
                    }
                }
            });

            // Calculate take profit from risk-reward ratio
            $('#calculate-tp-btn').click(function(e) {
                e.preventDefault();
                logger.logCalculation('CALCULATE_TP_FROM_RR_BUTTON_CLICKED', {});
                calculateTakeProfitFromRiskReward();
            });

            // Calculate take profit based on risk-reward ratio
            function calculateTakeProfitFromRiskReward() {
                const entryPrice = parseFloat($('#entry-price').val() || getCurrentRate($('#currency-pair').val()));
                const stopLossPrice = parseFloat($('#stop-loss-price').val());
                const stopLossPips = parseFloat($('#stop-loss-pips').val());
                const riskRewardRatio = parseFloat($('#risk-reward-ratio-input').val());
                const tradeDirection = $('#trade-direction').val();
                const currencyPair = $('#currency-pair').val();
                
                logger.logCalculation('CALCULATE_TP_FROM_RR_STARTED', {
                    entryPrice, stopLossPrice, stopLossPips, riskRewardRatio, tradeDirection, currencyPair
                });
                
                if (!currencyPair) {
                    alert('Please select a currency pair');
                    logger.logError('CALCULATE_TP_FROM_RR_ERROR', 'No currency pair selected');
                    return;
                }
                
                if (isNaN(entryPrice)) {
                    alert('Please enter an entry price or select a currency pair to use current rate');
                    logger.logError('CALCULATE_TP_FROM_RR_ERROR', 'No entry price');
                    return;
                }
                
                // Determine stop loss in pips if not directly entered
                let actualStopLossPips = stopLossPips;
                if (isNaN(actualStopLossPips) && !isNaN(stopLossPrice)) {
                    const pipSize = getPipSize(currencyPair);
                    
                    if (tradeDirection === 'buy') {
                        actualStopLossPips = (entryPrice - stopLossPrice) / pipSize;
                    } else {
                        actualStopLossPips = (stopLossPrice - entryPrice) / pipSize;
                    }
                    
                    logger.logCalculation('CALCULATE_TP_FROM_RR_SL_PIPS_CALCULATED', 
                        { entryPrice, stopLossPrice, pipSize, tradeDirection },
                        { actualStopLossPips }
                    );
                }
                
                if (isNaN(actualStopLossPips) || actualStopLossPips <= 0) {
                    alert('Please enter a valid stop loss');
                    logger.logError('CALCULATE_TP_FROM_RR_ERROR', 'Invalid stop loss', { actualStopLossPips });
                    return;
                }
                
                if (isNaN(riskRewardRatio) || riskRewardRatio <= 0) {
                    alert('Please enter a valid risk-reward ratio');
                    logger.logError('CALCULATE_TP_FROM_RR_ERROR', 'Invalid risk-reward ratio', { riskRewardRatio });
                    return;
                }
                
                // Calculate take profit pips based on risk-reward ratio
                const takeProfitPips = actualStopLossPips * riskRewardRatio;
                
                logger.logCalculation('CALCULATE_TP_FROM_RR_TP_PIPS_CALCULATED', 
                    { actualStopLossPips, riskRewardRatio },
                    { takeProfitPips }
                );
                
                // Calculate take profit price
                const pipDecimalPlaces = getPipDecimalPlaces(currencyPair);
                const pipSize = getPipSize(currencyPair);
                
                let takeProfitPrice;
                if (tradeDirection === 'buy') {
                    takeProfitPrice = entryPrice + (takeProfitPips * pipSize);
                } else {
                    takeProfitPrice = entryPrice - (takeProfitPips * pipSize);
                }
                
                logger.logCalculation('CALCULATE_TP_FROM_RR_TP_PRICE_CALCULATED', 
                    { entryPrice, takeProfitPips, pipSize, tradeDirection },
                    { takeProfitPrice }
                );
                
                // Update the take profit fields with one decimal place
                $('#take-profit-pips').val(takeProfitPips.toFixed(1));
                $('#take-profit-price').val(takeProfitPrice.toFixed(pipDecimalPlaces));
                
                // Switch to the price/pips tab to show the results
                $('#tp-price-tab').tab('show');
                
                logger.logCalculation('CALCULATE_TP_FROM_RR_COMPLETED', {
                    takeProfitPips: takeProfitPips.toFixed(1),
                    takeProfitPrice: takeProfitPrice.toFixed(pipDecimalPlaces)
                });
            }

            // Calculate position size when form is submitted
            $('#position-size-form').submit(function(e) {
                e.preventDefault();
                logger.logCalculation('CALCULATE_POSITION_SIZE_FORM_SUBMITTED', { timeframe: globalTimeframe });
                calculatePositionSize();
            });

            // Function to fetch forex rate (MetaAPI only)
            function fetchForexRate(currencyPair, updateEntryPrice = false) {
                $('#rate-display').show();
                $('#current-rate').html('<div class="loading-spinner"></div>');
                $('#timestamp').text('Fetching...');
                
                logger.logApi('FETCH_FOREX_RATE_STARTED', { currencyPair, updateEntryPrice });
                
                // Use MetaAPI as primary and only source
                fetchFromMetaAPI(currencyPair, updateEntryPrice);
            }

            // Fetch from MetaAPI (primary data source)
            async function fetchFromMetaAPI(currencyPair, updateEntryPrice) {
                if (!metaAPIInitialized) {
                    logger.logError('FETCH_METAAPI_NOT_INITIALIZED', 'MetaAPI not initialized');
                    $('#metaapi-status').removeClass('alert-success').addClass('alert-warning');
                    $('#metaapi-status-text').text('Please connect to MetaAPI first');
                    useFallbackRate(currencyPair, updateEntryPrice);
                    return;
                }
                
                logger.logApi('FETCH_METAAPI_REQUEST', { currencyPair });
                
                try {
                    // Get real-time price from MetaAPI
                    const priceData = await metaAPIService.getPrice(currencyPair);
                    
                    // Use mid price (average of bid and ask)
                    const rate = (priceData.bid + priceData.ask) / 2;
                    
                    logger.logApi('FETCH_METAAPI_RESPONSE', { currencyPair }, { 
                        bid: priceData.bid, 
                        ask: priceData.ask, 
                        rate, 
                        spread: priceData.spread 
                    });
                    
                    // Store rate
                    forexRates[currencyPair] = rate;
                    lastUpdateTime = new Date(priceData.time);
                    
                    // Display rate with spread information
                    displayMetaAPIRate(priceData, currencyPair, updateEntryPrice);
                    
                    // Hide manual data section when MetaAPI works
                    hideManualDataSection();
                    
                } catch (error) {
                    logger.logError('FETCH_METAAPI_ERROR', error.message, { currencyPair });
                    
                    // Check if it's a CORS error
                    const isCorsError = error.message.includes('CORS') || 
                                       error.message.includes('Network') || 
                                       error.message.includes('Failed to fetch') || 
                                       error.name === 'TypeError' ||
                                       (error.message && error.message.toLowerCase().includes('cross-origin'));
                    
                    if (isCorsError) {
                        logger.logError('FETCH_METAAPI_CORS_ERROR', 'CORS or network error detected', { 
                            error: error.message,
                            name: error.name,
                            stack: error.stack
                        });
                        
                        // Show clear CORS error message
                        showCorsError();
                        $('#current-rate').text('CORS Error - Use Manual Entry');
                        $('#timestamp').text('Network blocked - ' + new Date().toLocaleTimeString());
                        
                        // Update MetaAPI status to show CORS issue
                        $('#metaapi-status').removeClass('alert-success alert-info').addClass('alert-warning');
                        $('#metaapi-status-text').html('<i class="bi bi-exclamation-triangle"></i> CORS Error: Browser blocking MetaAPI requests. Use manual data entry below.');
                        
                    } else {
                        // Fall back to fallback rates or manual entry for other errors
                        useFallbackRate(currencyPair, updateEntryPrice);
                    }
                }
            }

            // Display MetaAPI rate with bid/ask spread
            function displayMetaAPIRate(priceData, currencyPair, updateEntryPrice = false) {
                const rate = (priceData.bid + priceData.ask) / 2;
                const formatted = formatRate(rate, currencyPair);
                const bidFormatted = formatRate(priceData.bid, currencyPair);
                const askFormatted = formatRate(priceData.ask, currencyPair);
                const spreadPips = ((priceData.ask - priceData.bid) / getPipSize(currencyPair)).toFixed(1);
                
                $('#current-rate').html(`
                    <div>${formatted} <small class="text-muted">(Mid)</small></div>
                    <div style="font-size: 0.8em; color: #666;">
                        Bid: ${bidFormatted} | Ask: ${askFormatted} | Spread: ${spreadPips} pips
                    </div>
                `);
                
                logger.logCalculation('DISPLAY_METAAPI_RATE', { 
                    rate, currencyPair, formatted, bidFormatted, askFormatted, spreadPips, updateEntryPrice 
                });
                
                const timeString = lastUpdateTime.toLocaleTimeString() + ' ' + lastUpdateTime.toLocaleDateString();
                $('#timestamp').text(timeString + ' (Real-time)');
                $('#api-update-time').text(timeString);
                // Keep manual section available but indicate API is working
                $('#manual-data-section').show();
                $('#metaapi-status').removeClass('alert-warning').addClass('alert-success');
                $('#metaapi-status-text').html('<i class="bi bi-check-circle"></i> MetaAPI connected - real-time data active');
                
                // Update entry price field if requested and no manual entry has been made
                if (updateEntryPrice && !$('#entry-price').val()) {
                    $('#entry-price').val(formatted);
                    logger.logCalculation('ENTRY_PRICE_UPDATED_FROM_METAAPI_RATE', { newEntryPrice: formatted });
                }
                
                // Recalculate stop loss/take profit values if they depend on entry price
                updateDependentValues();
            }
            
            
            // Use fallback rate when both APIs fail
            function useFallbackRate(currencyPair, updateEntryPrice) {
                if (fallbackRates[currencyPair]) {
                    logger.logApi('USING_FALLBACK_RATE', { currencyPair, rate: fallbackRates[currencyPair] });
                    displayRate(fallbackRates[currencyPair], currencyPair, updateEntryPrice, true);
                    // Don't hide manual section - show it as an option even when fallback works
                    showManualDataSection();
                } else {
                    logger.logError('FALLBACK_RATE_NOT_AVAILABLE', 'No fallback rate available for this pair', { currencyPair });
                    $('#current-rate').text('Rate unavailable');
                    $('#timestamp').text('Could not fetch rate');
                    showManualDataSection(); // Show manual section when all APIs fail
                }
            }

            // Function to display rate
            function displayRate(rate, currencyPair, updateEntryPrice = false, isFallback = false) {
                const formatted = formatRate(rate, currencyPair);
                $('#current-rate').text(formatted);
                
                logger.logCalculation('DISPLAY_RATE', { rate, currencyPair, formatted, updateEntryPrice, isFallback });
                
                if (isFallback) {
                    $('#timestamp').text('Using fallback rate (API unavailable)');
                    showManualDataSection(); // Show manual section when using fallback
                } else {
                    const timeString = lastUpdateTime.toLocaleTimeString() + ' ' + lastUpdateTime.toLocaleDateString();
                    $('#timestamp').text(timeString);
                    $('#api-update-time').text(timeString);
                    // Keep manual section available even when API works, but show it's optional
                    $('#manual-data-section').show();
                }
                
                // Update entry price field if requested and no manual entry has been made
                if (updateEntryPrice && !$('#entry-price').val()) {
                    $('#entry-price').val(formatted);
                    logger.logCalculation('ENTRY_PRICE_UPDATED_FROM_RATE', { newEntryPrice: formatted });
                }
                
                // Recalculate stop loss/take profit values if they depend on entry price
                updateDependentValues();
            }
            
            // Update any dependent values when entry price changes
            function updateDependentValues() {
                logger.logCalculation('UPDATE_DEPENDENT_VALUES_STARTED', {});
                
                // Trigger events to recalculate stop loss/take profit
                if ($('#stop-loss-pips').val()) {
                    $('#stop-loss-pips').trigger('input');
                    logger.logCalculation('RECALCULATED_SL_PRICE_FROM_PIPS', {});
                }
                if ($('#take-profit-pips').val()) {
                    $('#take-profit-pips').trigger('input');
                    logger.logCalculation('RECALCULATED_TP_PRICE_FROM_PIPS', {});
                }
            }

            // Get pip decimal places based on currency pair (for display formatting)
            function getPipDecimalPlaces(currencyPair) {
                let decimals;
                if (currencyPair.includes('JPY')) {
                    decimals = 3; // JPY pairs have 3 decimal places (2 pips)
                } else if (currencyPair === 'XAUUSD') {
                    decimals = 2; // Gold has 2 decimal places
                } else {
                    decimals = 5; // Most currency pairs have 5 decimal places (4 pips)
                }
                
                logger.logCalculation('GET_PIP_DECIMAL_PLACES', { currencyPair }, { decimals });
                return decimals;
            }

            // Get actual pip size for calculations (not display)
            function getPipSize(currencyPair) {
                let pipSize;
                if (currencyPair.includes('JPY')) {
                    pipSize = 0.01; // JPY pairs: 1 pip = 0.01
                } else if (currencyPair === 'XAUUSD') {
                    pipSize = 0.01; // Gold: 1 pip = 0.01
                } else {
                    pipSize = 0.0001; // Standard pairs: 1 pip = 0.0001
                }
                
                logger.logCalculation('GET_PIP_SIZE', { currencyPair }, { pipSize });
                return pipSize;
            }

            // Format rate according to currency pair
            function formatRate(rate, currencyPair) {
                const decimalPlaces = getPipDecimalPlaces(currencyPair);
                const formatted = rate.toFixed(decimalPlaces);
                logger.logCalculation('FORMAT_RATE', { rate, currencyPair, decimalPlaces }, { formatted });
                return formatted;
            }

            // Calculate position size
            function calculatePositionSize() {
                // Get form values
                const currencyPair = $('#currency-pair').val();
                const accountCurrency = $('#account-currency').val();
                const accountSize = parseFloat($('#account-size').val());
                const riskPercentage = parseFloat($('#risk-percentage').val()) / 100;
                const tradeDirection = $('#trade-direction').val();
                const lotSize = lotSizes[selectedLotSize];
                
                logger.logCalculation('CALCULATE_POSITION_SIZE_STARTED', {
                    currencyPair, accountCurrency, accountSize, riskPercentage, tradeDirection, lotSize, timeframe: globalTimeframe
                });
                
                // Get stop loss details
                const entryPrice = parseFloat($('#entry-price').val() || getCurrentRate(currencyPair));
                let stopLossPrice = parseFloat($('#stop-loss-price').val());
                let stopLossPips = parseFloat($('#stop-loss-pips').val());
                
                logger.logCalculation('SL_INPUT_VALUES', { entryPrice, stopLossPrice, stopLossPips });
                
                // If ATR-based stop loss is active, use that
                if ($('#sl-atr-tab').hasClass('active')) {
                    const atrValue = parseFloat($('#atr-value').val());
                    const atrMultiplier = parseFloat($('#atr-multiplier').val());
                    
                    logger.logCalculation('USING_ATR_BASED_SL', { atrValue, atrMultiplier });
                    
                    if (!isNaN(atrValue) && !isNaN(atrMultiplier)) {
                        // Calculate ATR-based stop loss in pips
                        const pipSize = getPipSize(currencyPair);
                        
                        // Convert ATR to pips
                        const atrPips = atrValue / pipSize;
                        stopLossPips = Math.round(atrPips * atrMultiplier); // Ensure integer
                        
                        logger.logCalculation('ATR_SL_CALCULATION', 
                            { atrValue, atrMultiplier, pipSize, atrPips },
                            { stopLossPips }
                        );
                        
                        // Calculate stop loss price
                        if (tradeDirection === 'buy') {
                            stopLossPrice = entryPrice - (stopLossPips * pipSize);
                        } else {
                            stopLossPrice = entryPrice + (stopLossPips * pipSize);
                        }
                        
                        logger.logCalculation('ATR_SL_PRICE_CALCULATION', 
                            { entryPrice, stopLossPips, pipSize, tradeDirection },
                            { stopLossPrice }
                        );
                    }
                }
                
                // Get take profit details
                let takeProfitPrice = parseFloat($('#take-profit-price').val());
                let takeProfitPips = parseInt($('#take-profit-pips').val(), 10); // Parse as integer
                
                logger.logCalculation('TP_INPUT_VALUES', { takeProfitPrice, takeProfitPips });
                
                // If ATR-based take profit is active, use that
                if ($('#tp-atr-tab').hasClass('active')) {
                    const atrValue = parseFloat($('#atr-value').val());
                    const tpAtrMultiplier = parseFloat($('#tp-atr-multiplier').val());
                    
                    logger.logCalculation('USING_ATR_BASED_TP', { atrValue, tpAtrMultiplier });
                    
                    if (!isNaN(atrValue) && !isNaN(tpAtrMultiplier)) {
                        // Calculate ATR-based take profit in pips
                        const pipSize = getPipSize(currencyPair);
                        
                        // Convert ATR to pips
                        const atrPips = atrValue / pipSize;
                        takeProfitPips = Math.round(atrPips * tpAtrMultiplier); // Ensure integer
                        
                        logger.logCalculation('ATR_TP_CALCULATION', 
                            { atrValue, tpAtrMultiplier, pipSize, atrPips },
                            { takeProfitPips }
                        );
                        
                        // Calculate take profit price
                        if (tradeDirection === 'buy') {
                            takeProfitPrice = entryPrice + (takeProfitPips * pipSize);
                        } else {
                            takeProfitPrice = entryPrice - (takeProfitPips * pipSize);
                        }
                        
                        logger.logCalculation('ATR_TP_PRICE_CALCULATION', 
                            { entryPrice, takeProfitPips, pipSize, tradeDirection },
                            { takeProfitPrice }
                        );
                    }
                }
                // If take profit price is not provided, calculate it from pips
                else if (isNaN(takeProfitPrice) && !isNaN(takeProfitPips)) {
                    const pipSize = getPipSize(currencyPair);
                    
                    if (tradeDirection === 'buy') {
                        takeProfitPrice = entryPrice + (takeProfitPips * pipSize);
                    } else {
                        takeProfitPrice = entryPrice - (takeProfitPips * pipSize);
                    }
                    
                    logger.logCalculation('CALCULATE_TP_PRICE_FROM_PIPS', 
                        { entryPrice, takeProfitPips, pipSize, tradeDirection },
                        { takeProfitPrice }
                    );
                }
                // If take profit pips is not provided, calculate it from price
                else if (!isNaN(takeProfitPrice) && isNaN(takeProfitPips)) {
                    const pipSize = getPipSize(currencyPair);
                    
                    if (tradeDirection === 'buy') {
                        takeProfitPips = Math.round((takeProfitPrice - entryPrice) / pipSize); // Ensure integer
                    } else {
                        takeProfitPips = Math.round((entryPrice - takeProfitPrice) / pipSize); // Ensure integer
                    }
                    
                    logger.logCalculation('CALCULATE_TP_PIPS_FROM_PRICE', 
                        { entryPrice, takeProfitPrice, pipSize, tradeDirection },
                        { takeProfitPips }
                    );
                }

                // Validate stop loss
                if (isNaN(stopLossPips) || stopLossPips <= 0) {
                    alert('Please enter a valid stop loss');
                    logger.logError('CALCULATE_POSITION_SIZE_ERROR', 'Invalid stop loss', { stopLossPips });
                    return;
                }

                // Calculate risk amount
                const riskAmount = accountSize * riskPercentage;
                logger.logCalculation('RISK_AMOUNT_CALCULATION', { accountSize, riskPercentage }, { riskAmount });

                // Parse currency pair
                const baseCurrency = currencyPair.substring(0, 3);
                const quoteCurrency = currencyPair.substring(3, 6);

                // Debug variables
                let debugInfo = {};
                debugInfo.globalTimeframe = globalTimeframe;
                
                // Get pip size based on currency pair
                const pipDecimalPlaces = getPipDecimalPlaces(currencyPair);
                const pipSize = Math.pow(10, -pipDecimalPlaces);
                
                // Calculate pip value in quote currency per standard lot
                let pipValueInQuoteCurrency;
                
                // Standard lot size for reference (100,000 units)
                const standardLotSize = 100000;
                
                // Special handling for different currency pairs
                if (currencyPair === 'XAUUSD') {
                    // Gold is quoted in USD per oz, and 1 pip is 0.01 USD
                    // For gold, standard lot is usually 100 oz
                    pipValueInQuoteCurrency = pipSize * 100; // 0.01 * 100 = 1 USD per pip for 1 standard lot
                } else if (currencyPair.includes('JPY')) {
                    // For JPY pairs, 1 pip is 0.01
                    pipValueInQuoteCurrency = 0.01 * (standardLotSize / 100); // 0.01 * 1000 = 10 JPY per pip for 1 standard lot
                } else {
                    // For regular forex pairs
                    pipValueInQuoteCurrency = 0.0001 * standardLotSize; // 0.0001 * 100000 = 10 USD/EUR/etc per pip for 1 standard lot
                }
                
                logger.logCalculation('PIP_VALUE_IN_QUOTE_CURRENCY', 
                    { currencyPair, pipSize, standardLotSize },
                    { pipValueInQuoteCurrency }
                );
                
                // Add to debug info
                debugInfo.pipSize = pipSize;
                debugInfo.pipValueInQuoteCurrency = pipValueInQuoteCurrency;
                debugInfo.standardLotSize = standardLotSize;

                // Convert pip value to account currency
                let pipValueInAccountCurrency;
                
                if (quoteCurrency === accountCurrency) {
                    // Direct quote to account currency (e.g., EUR/USD with USD account)
                    pipValueInAccountCurrency = pipValueInQuoteCurrency;
                    logger.logCalculation('PIP_VALUE_DIRECT_QUOTE', 
                        { quoteCurrency, accountCurrency },
                        { pipValueInAccountCurrency }
                    );
                } else if (baseCurrency === accountCurrency) {
                    // Base currency is account currency (e.g., EUR/USD with EUR account)
                    pipValueInAccountCurrency = pipValueInQuoteCurrency / entryPrice;
                    logger.logCalculation('PIP_VALUE_BASE_CURRENCY', 
                        { baseCurrency, accountCurrency, entryPrice },
                        { pipValueInAccountCurrency }
                    );
                } else {
                    // Cross rate - need conversion through another currency
                    // We'll try to get conversion rates from our forexRates object
                    logger.logCalculation('PIP_VALUE_CROSS_RATE_STARTED', 
                        { baseCurrency, quoteCurrency, accountCurrency }
                    );
                    
                    // Convert to USD first (as a common intermediary)
                    let quoteToUsd;
                    if (quoteCurrency === 'USD') {
                        quoteToUsd = 1;
                    } else {
                        // Try to get from forexRates if we have it
                        const quotePair = `${quoteCurrency}USD`;
                        const usdQuotePair = `USD${quoteCurrency}`;
                        
                        if (forexRates[quotePair]) {
                            quoteToUsd = forexRates[quotePair];
                        } else if (forexRates[usdQuotePair]) {
                            quoteToUsd = 1 / forexRates[usdQuotePair];
                        } else if (usdConversionRates[quoteCurrency]) {
                            quoteToUsd = usdConversionRates[quoteCurrency];
                        } else {
                            quoteToUsd = 1; // Fallback
                        }
                    }
                    
                    logger.logCalculation('QUOTE_TO_USD_CONVERSION', 
                        { quoteCurrency },
                        { quoteToUsd }
                    );
                    
                    // Convert USD to account currency
                    let usdToAccount;
                    if (accountCurrency === 'USD') {
                        usdToAccount = 1;
                    } else {
                        // Try to get from forexRates if we have it
                        const accountPair = `USD${accountCurrency}`;
                        const accountUsdPair = `${accountCurrency}USD`;
                        
                        if (forexRates[accountPair]) {
                            usdToAccount = forexRates[accountPair];
                        } else if (forexRates[accountUsdPair]) {
                            usdToAccount = 1 / forexRates[accountUsdPair];
                        } else if (usdConversionRates[accountCurrency]) {
                            usdToAccount = 1 / usdConversionRates[accountCurrency];
                        } else {
                            usdToAccount = 1; // Fallback
                        }
                    }
                    
                    logger.logCalculation('USD_TO_ACCOUNT_CONVERSION', 
                        { accountCurrency },
                        { usdToAccount }
                    );
                    
                    // Calculate final pip value in account currency
                    pipValueInAccountCurrency = pipValueInQuoteCurrency * quoteToUsd * usdToAccount;
                    
                    logger.logCalculation('PIP_VALUE_CROSS_RATE_RESULT', 
                        { pipValueInQuoteCurrency, quoteToUsd, usdToAccount },
                        { pipValueInAccountCurrency }
                    );
                    
                    // Add conversion rates to debug info
                    debugInfo.quoteToUsd = quoteToUsd;
                    debugInfo.usdToAccount = usdToAccount;
                }
                
                // Add to debug info
                debugInfo.pipValueInAccountCurrency = pipValueInAccountCurrency;
                
                // Calculate position size in standard lots (100,000 units)
                const positionSizeInStandardLots = riskAmount / (stopLossPips * pipValueInAccountCurrency);
                
                logger.logCalculation('POSITION_SIZE_IN_STANDARD_LOTS', 
                    { riskAmount, stopLossPips, pipValueInAccountCurrency },
                    { positionSizeInStandardLots }
                );
                
                // Convert to selected lot size
                const selectedLotRatio = lotSize / standardLotSize;
                const positionSizeInSelectedLots = positionSizeInStandardLots / selectedLotRatio;
                
                logger.logCalculation('POSITION_SIZE_IN_SELECTED_LOTS', 
                    { positionSizeInStandardLots, selectedLotRatio, lotSize, standardLotSize },
                    { positionSizeInSelectedLots }
                );
                
                // Add to debug info
                debugInfo.positionSizeInStandardLots = positionSizeInStandardLots;
                debugInfo.selectedLotRatio = selectedLotRatio;
                debugInfo.positionSizeInSelectedLots = positionSizeInSelectedLots;
                
                // Adjust to appropriate lot step (usually 0.01)
                const adjustedPositionSizeInLots = Math.floor(positionSizeInSelectedLots * 100) / 100;
                
                logger.logCalculation('ADJUSTED_POSITION_SIZE', 
                    { positionSizeInSelectedLots },
                    { adjustedPositionSizeInLots }
                );
                
                // Calculate position size in units
                const positionSizeUnits = adjustedPositionSizeInLots * lotSize;
                
                logger.logCalculation('POSITION_SIZE_UNITS', 
                    { adjustedPositionSizeInLots, lotSize },
                    { positionSizeUnits }
                );
                
                // Calculate actual risk amount with adjusted position size
                const actualRiskAmount = adjustedPositionSizeInLots * stopLossPips * (pipValueInAccountCurrency * selectedLotRatio);
                
                logger.logCalculation('ACTUAL_RISK_AMOUNT', 
                    { adjustedPositionSizeInLots, stopLossPips, pipValueInAccountCurrency, selectedLotRatio },
                    { actualRiskAmount }
                );
                
                // Add to debug info
                debugInfo.adjustedPositionSizeInLots = adjustedPositionSizeInLots;
                debugInfo.positionSizeUnits = positionSizeUnits;
                debugInfo.actualRiskAmount = actualRiskAmount;
                
                // Calculate potential profit if take profit is set
                let potentialProfit = 0;
                let riskRewardRatio = '-';
                let riskRewardDisplay = '-';
                
                if (!isNaN(takeProfitPips) && takeProfitPips > 0) {
                    potentialProfit = adjustedPositionSizeInLots * takeProfitPips * (pipValueInAccountCurrency * selectedLotRatio);
                    const ratio = (potentialProfit / actualRiskAmount).toFixed(2);
                    riskRewardRatio = '1:' + ratio;
                    
                    // Create enhanced display with actual amounts
                    riskRewardDisplay = `
                        <div class="risk-reward-display">
                            <div class="risk-reward-ratio">
                                <i class="bi bi-graph-up-arrow me-2"></i>${riskRewardRatio}
                            </div>
                            <div class="risk-reward-explanation">
                                Net profit ratio if trade reaches take profit target
                            </div>
                            <div class="risk-reward-breakdown">
                                <div class="risk-amount">
                                    <div class="fw-bold">Risk</div>
                                    <div>${formatCurrencyAmount(actualRiskAmount, accountCurrency, 0)}</div>
                                </div>
                                <div class="vs-separator">vs</div>
                                <div class="reward-amount">
                                    <div class="fw-bold">Reward</div>
                                    <div>${formatCurrencyAmount(potentialProfit, accountCurrency, 0)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    logger.logCalculation('POTENTIAL_PROFIT', 
                        { adjustedPositionSizeInLots, takeProfitPips, pipValueInAccountCurrency, selectedLotRatio },
                        { potentialProfit, riskRewardRatio, riskRewardDisplay }
                    );
                }
                
                // Add to debug info
                debugInfo.potentialProfit = potentialProfit;
                debugInfo.riskRewardRatio = riskRewardRatio;
                debugInfo.riskRewardDisplay = riskRewardDisplay;
                debugInfo.timeframeFactors = timeframeFactors;
                
                // Display debug info
                $('#debug-content').html(
                    `<pre>${JSON.stringify(debugInfo, null, 2)}</pre>`
                );

                // Display results
                $('#position-size-lots').text(adjustedPositionSizeInLots.toFixed(2));
                $('#position-size-units').text(formatNumberWithSeparators(Math.round(positionSizeUnits), 0, useThousandSeparators));
                $('#risk-amount').text(formatCurrencyAmount(actualRiskAmount, accountCurrency));
                $('#pip-value').text(formatCurrencyAmount(pipValueInAccountCurrency * selectedLotRatio * adjustedPositionSizeInLots, accountCurrency));
                $('#stop-loss-distance').text(`${stopLossPips.toFixed(1)} pips`);
                
                // Display take profit details if available
                if (!isNaN(takeProfitPips) && takeProfitPips > 0) {
                    $('#take-profit-distance').text(`${takeProfitPips.toFixed(1)} pips`);
                    $('#risk-reward-ratio-display').html(riskRewardDisplay);
                    $('#potential-profit').text(formatCurrencyAmount(potentialProfit, accountCurrency));
                    $('#potential-profit').addClass('positive');
                } else {
                    $('#take-profit-distance').text('Not set');
                    $('#risk-reward-ratio-display').html('<div class="text-muted">Not calculated</div>');
                    $('#potential-profit').text('Not calculated');
                    $('#potential-profit').removeClass('positive');
                }
                
                logger.logCalculation('CALCULATE_POSITION_SIZE_COMPLETED', {
                    positionSizeLots: adjustedPositionSizeInLots.toFixed(2),
                    positionSizeUnits: Math.round(positionSizeUnits),
                    riskAmount: actualRiskAmount.toFixed(2),
                    pipValue: (pipValueInAccountCurrency * selectedLotRatio * adjustedPositionSizeInLots).toFixed(2),
                    stopLossDistance: stopLossPips.toFixed(1),
                    takeProfitDistance: takeProfitPips ? takeProfitPips.toFixed(1) : 'Not set',
                    riskRewardRatio: riskRewardRatio,
                    riskRewardDisplay: riskRewardDisplay,
                    potentialProfit: potentialProfit ? potentialProfit.toFixed(2) : 'Not calculated',
                    timeframe: globalTimeframe
                });
                
                // Show results container
                $('#result-container').fadeIn();
            }

            // Utility function to format numbers with optional thousand separators
            function formatNumberWithSeparators(number, decimals = 0, useThousandSeparators = true) {
                // Format to specified decimal places
                const formatted = number.toFixed(decimals);
                
                // Add thousand separators if requested
                if (useThousandSeparators) {
                    // Split into integer and decimal parts
                    const parts = formatted.split('.');
                    
                    // Add commas to integer part
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    
                    // Rejoin parts
                    return parts.join('.');
                } else {
                    return formatted;
                }
            }
            
            // Currency symbol mapping function
            function getCurrencySymbol(currencyCode) {
                const currencySymbols = {
                    'USD': '$',
                    'EUR': '€',
                    'GBP': '£',
                    'JPY': '¥',
                    'AUD': 'A$',
                    'CAD': 'C$',
                    'CHF': 'CHF ',
                    'NZD': 'NZ$'
                };
                
                const symbol = currencySymbols[currencyCode];
                logger.logCalculation('GET_CURRENCY_SYMBOL', { currencyCode }, { symbol });
                return symbol || currencyCode + ' '; // Fallback to currency code with space
            }
            
            // Format currency amount with proper symbol
            function formatCurrencyAmount(amount, currencyCode, decimals = 2) {
                const symbol = getCurrencySymbol(currencyCode);
                const formattedAmount = formatNumberWithSeparators(amount, decimals, useThousandSeparators);
                
                // For currencies that use symbol prefix (most currencies)
                if (['$', '€', '£', '¥', 'A$', 'C$', 'NZ$'].includes(symbol)) {
                    return symbol + formattedAmount;
                } else {
                    // For currencies that use symbol suffix or code (like CHF)
                    return symbol + formattedAmount;
                }
            }

            // Get current rate (or fallback)
            function getCurrentRate(currencyPair) {
                if (forexRates[currencyPair]) {
                    logger.logCalculation('GET_CURRENT_RATE_FROM_STORED', { currencyPair }, { rate: forexRates[currencyPair] });
                    return forexRates[currencyPair];
                } else if (fallbackRates[currencyPair]) {
                    logger.logCalculation('GET_CURRENT_RATE_FROM_FALLBACK', { currencyPair }, { rate: fallbackRates[currencyPair] });
                    return fallbackRates[currencyPair];
                } else {
                    logger.logCalculation('GET_CURRENT_RATE_DEFAULT', { currencyPair }, { rate: 1.0000 });
                    return 1.0000; // Default fallback
                }
            }

            // Settings Event Handlers
            
            // Save Settings Button
            $('#save-settings-btn').click(function() {
                const settings = settingsManager.collectSettingsFromUI();
                settingsManager.saveAllSettings(settings);
                
                // Apply settings to main form
                settingsManager.applySettingsToUI(settings);
                
                // Update global variables
                selectedLotSize = settings.default_lot_size;
                globalTimeframe = settings.global_timeframe;
                useThousandSeparators = settings.use_thousand_separators;
                
                // Update timeframe display
                $('.timeframe-option').removeClass('active');
                $(`.timeframe-option[data-timeframe="${settings.global_timeframe}"]`).addClass('active');
                const timeframeText = $(`.timeframe-option[data-timeframe="${settings.global_timeframe}"]`).text();
                $('#atr-timeframe-display').text(timeframeText + ' timeframe');
                
                // Update lot size selection
                $('.lot-option').removeClass('active');
                $(`.lot-option[data-lot-type="${settings.default_lot_size}"]`).addClass('active');
                
                // Show success message
                alert('Settings saved successfully!');
                
                // Close modal
                $('#settingsModal').modal('hide');
                
                logger.logCalculation('SETTINGS_SAVED_AND_APPLIED', {}, settings);
            });
            
            // Reset Settings Button
            $('#reset-settings-btn').click(function() {
                if (confirm('Are you sure you want to reset all settings to defaults? This will clear all saved preferences including MetaAPI credentials.')) {
                    const defaults = settingsManager.resetToDefaults();
                    
                    // Reset global variables
                    selectedLotSize = defaults.default_lot_size;
                    globalTimeframe = defaults.global_timeframe;
                    metaAPIInitialized = false;
                    
                    // Reset MetaAPI status
                    metaAPIStatusManager.setDisconnected('Settings reset - please reconnect');
                    
                    // Update UI elements
                    $('#metaapi-connect-btn').prop('disabled', false).html('<i class="bi bi-plug"></i> Initialize MetaAPI');
                    $('#metaapi-status').show().removeClass('alert-success alert-danger').addClass('alert-warning');
                    $('#metaapi-status-text').text('Settings reset. Please enter your MetaAPI credentials.');
                    
                    alert('Settings reset to defaults successfully!');
                    
                    logger.logCalculation('SETTINGS_RESET_COMPLETED', {});
                }
            });
            
            // Account Currency Change Handler (Settings Modal)
            $('#settings-account-currency').change(function() {
                const newCurrency = $(this).val();
                const currencySymbol = getCurrencySymbol(newCurrency);
                $('#settings-account-currency-symbol').text(currencySymbol);
                
                // Also update main form
                $('#account-currency').val(newCurrency);
                $('.account-currency-symbol').text(currencySymbol);
                
                logger.logCalculation('ACCOUNT_CURRENCY_CHANGED_IN_SETTINGS', { newCurrency, currencySymbol });
            });
            
            // Sync settings between modal and main form
            $('#settings-account-size, #settings-risk-percentage').on('input change', function() {
                const accountSize = $('#settings-account-size').val();
                const riskPercentage = $('#settings-risk-percentage').val();
                
                // Update main form fields
                $('#account-size').val(accountSize);
                $('#risk-percentage').val(riskPercentage);
                
                logger.logCalculation('ACCOUNT_SETTINGS_SYNCED', { accountSize, riskPercentage });
            });
            
            // Sync SL multiplier changes
            $('#settings-default-sl-multiplier').on('input change', function() {
                const slMultiplier = $(this).val();
                $('#atr-multiplier').val(slMultiplier);
                logger.logCalculation('SL_MULTIPLIER_SYNCED', { slMultiplier });
            });
            
            // Sync TP ratio changes
            $('#settings-default-tp-ratio').on('input change', function() {
                const tpRatio = $(this).val();
                $('#risk-reward-ratio-input').val(tpRatio);
                logger.logCalculation('TP_RATIO_SYNCED', { tpRatio });
            });
            
            // Sync timeframe changes from settings modal to main form
            $('#settings-global-timeframe').on('change', function() {
                const newTimeframe = $(this).val();
                
                // Update main form timeframe buttons
                $('.timeframe-option').removeClass('active');
                $(`.timeframe-option[data-timeframe="${newTimeframe}"]`).addClass('active');
                
                // Update global variable
                globalTimeframe = newTimeframe;
                
                // Update timeframe display
                const timeframeText = $(`.timeframe-option[data-timeframe="${newTimeframe}"]`).text();
                $('#atr-timeframe-display').text(timeframeText + ' timeframe');
                
                logger.logCalculation('TIMEFRAME_SYNCED_FROM_SETTINGS', { newTimeframe });
            });
            
            // Thousand separators checkbox change handler
            $('#settings-use-thousand-separators').on('change', function() {
                const useThousands = $(this).is(':checked');
                
                // Update global variable immediately
                useThousandSeparators = useThousands;
                
                // Update account size display in settings modal to show immediate feedback
                const accountSize = parseFloat($('#settings-account-size').val()) || 10000;
                const formattedAccountSize = formatNumberWithSeparators(accountSize, 0, useThousands);
                
                // Temporarily update the input value to show the formatting change
                const $accountSizeInput = $('#settings-account-size');
                const originalValue = $accountSizeInput.val();
                $accountSizeInput.val(formattedAccountSize);
                
                // Restore the original numeric value after a brief moment to maintain functionality
                setTimeout(function() {
                    $accountSizeInput.val(originalValue);
                }, 1500);
                
                logger.logCalculation('THOUSAND_SEPARATORS_TOGGLED', { 
                    useThousands, 
                    accountSize, 
                    formattedAccountSize 
                });
            });
            
            // Auto-populate MetaAPI credentials on page load
            async function autoPopulateCredentials() {
                try {
                    let apiKey = '';
                    let accountId = '';
                    let region = 'new-york';
                    let source = 'none';
                    
                    console.log('Checking for credentials...');
                    
                    // Priority 1: Try to load from localStorage first
                    try {
                        const storedKey = localStorage.getItem('forex_calc_metaapi_key');
                        const storedAccount = localStorage.getItem('forex_calc_metaapi_account');
                        const storedRegion = localStorage.getItem('forex_calc_metaapi_region');
                        
                        if (storedKey && storedAccount) {
                            apiKey = storedKey;
                            accountId = storedAccount;
                            region = storedRegion || 'new-york';
                            source = 'localStorage';
                            console.log('Found credentials in localStorage:', { hasApiKey: !!apiKey, hasAccountId: !!accountId, region });
                        }
                    } catch (storageError) {
                        console.warn('localStorage not available:', storageError);
                        logger.logError('LOCALSTORAGE_READ_FAILED', storageError.message);
                    }
                    
                    // Priority 2: Try to load from config file if not found in localStorage
                    if (!apiKey || !accountId) {
                        if (typeof window !== 'undefined' && window.ENV_CONFIG) {
                            apiKey = apiKey || window.ENV_CONFIG.METAAPI_API_KEY || '';
                            accountId = accountId || window.ENV_CONFIG.METAAPI_ACCOUNT_ID || '';
                            region = region || window.ENV_CONFIG.METAAPI_REGION || 'new-york';
                            if (apiKey && accountId) {
                                source = 'config';
                                console.log('Found credentials in config:', { hasApiKey: !!apiKey, hasAccountId: !!accountId, region });
                            }
                        }
                    }
                    
                    // Auto-fill the form fields if we found values
                    if (apiKey) {
                        $('#metaapi-key').val(apiKey);
                        console.log('Auto-populated API key from', source);
                        logger.logApi('METAAPI_KEY_AUTO_POPULATED', { source });
                    }
                    if (accountId) {
                        $('#metaapi-account').val(accountId);
                        console.log('Auto-populated Account ID from', source);
                        logger.logApi('METAAPI_ACCOUNT_AUTO_POPULATED', { source });
                    }
                    if (region) {
                        $('#metaapi-region').val(region);
                        console.log('Auto-populated region from', source, ':', region);
                        logger.logApi('METAAPI_REGION_AUTO_POPULATED', { source, region });
                    }
                    
                    // If both credentials are available, auto-initialize MetaAPI
                    if (apiKey && accountId) {
                        console.log('Credentials ready for auto-initialization from', source);
                        logger.logApi('METAAPI_AUTO_INIT_STARTED', { hasApiKey: !!apiKey, hasAccountId: !!accountId, source });
                        
                        // Update UI to show auto-initializing state
                        const $btn = $('#metaapi-connect-btn');
                        $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Auto-initializing...');
                        $('#metaapi-status').show().removeClass('alert-success alert-danger alert-warning').addClass('alert-info');
                        const sourceText = source === 'localStorage' ? 'saved credentials' : 'configuration';
                        $('#metaapi-status-text').text(`Auto-initializing MetaAPI with ${sourceText}...`);
                        
                        try {
                            // Initialize MetaAPI (simple connection, no sync wait)
                            await metaAPIService.initialize(apiKey, accountId, region);
                            
                            // Update UI for successful initialization
                            metaAPIInitialized = true;
                            $btn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> MetaAPI Ready');
                            $('#metaapi-status').removeClass('alert-info').addClass('alert-success');
                            $('#metaapi-status-text').html('<i class="bi bi-check-circle"></i> MetaAPI auto-initialized successfully! Data will be fetched on-demand when needed.');
                            
                            logger.logApi('METAAPI_AUTO_INIT_SUCCESS', { accountId, region, source });
                            console.log('MetaAPI auto-initialized successfully from', source);
                            
                            // Refresh current pair if selected
                            const currencyPair = $('#currency-pair').val();
                            if (currencyPair) {
                                fetchForexRate(currencyPair, true);
                            }
                            
                        } catch (error) {
                            // Update UI for failed initialization
                            metaAPIInitialized = false;
                            $btn.prop('disabled', false).html('<i class="bi bi-plug"></i> Initialize MetaAPI');
                            
                            $('#metaapi-status').removeClass('alert-info').addClass('alert-warning');
                            $('#metaapi-status-text').html(`<i class="bi bi-exclamation-triangle"></i> Auto-initialization failed: ${error.message}. Click "Initialize MetaAPI" to retry.`);
                            
                            logger.logError('METAAPI_AUTO_INIT_FAILED', error.message, { accountId, region, source });
                            console.warn('MetaAPI auto-initialization failed:', error);
                        }
                    } else {
                        console.log('Missing credentials:', { hasApiKey: !!apiKey, hasAccountId: !!accountId });
                        $('#metaapi-status').show().removeClass('alert-success').addClass('alert-warning');
                        $('#metaapi-status-text').text('Please enter your MetaAPI credentials or check your configuration file.');
                    }
                    
                } catch (error) {
                    console.error('Auto-populate failed:', error);
                    logger.logError('AUTO_POPULATE_CREDENTIALS_FAILED', error.message);
                }
            }

            // Show MetaAPI configuration by default (now in settings modal)
            $('#metaapi-config').show();
            
            // Initialize Settings System
            function initializeSettings() {
                logger.logCalculation('INITIALIZING_SETTINGS_SYSTEM', {});
                
                // Load saved settings
                const savedSettings = settingsManager.loadSettings();
                
                // Apply settings to UI
                settingsManager.applySettingsToUI(savedSettings);
                
                // Update global variables
                selectedLotSize = savedSettings.default_lot_size;
                globalTimeframe = savedSettings.global_timeframe;
                useThousandSeparators = savedSettings.use_thousand_separators;
                
                // Update timeframe display
                const timeframeText = $(`.timeframe-option[data-timeframe="${savedSettings.global_timeframe}"]`).text();
                $('#atr-timeframe-display').text(timeframeText + ' timeframe');
                
                // Initialize currency symbols
                const currencySymbol = getCurrencySymbol(savedSettings.account_currency);
                $('.account-currency-symbol').text(currencySymbol);
                $('#settings-account-currency-symbol').text(currencySymbol);
                
                // Initialize MetaAPI status as disconnected
                metaAPIStatusManager.setDisconnected('Not connected');
                
                logger.logCalculation('SETTINGS_SYSTEM_INITIALIZED', {}, savedSettings);
                
                return savedSettings;
            }
            
            // Enhanced auto-populate with settings integration
            async function autoPopulateAndInitialize() {
                // Initialize settings first
                const settings = initializeSettings();
                
                try {
                    let apiKey = settings.metaapi_key;
                    let accountId = settings.metaapi_account;
                    let region = settings.metaapi_region;
                    let source = 'settings';
                    
                    console.log('Checking for credentials...', { hasApiKey: !!apiKey, hasAccountId: !!accountId, source });
                    
                    // Try to load from config file if not in settings
                    if (!apiKey || !accountId) {
                        if (typeof window !== 'undefined' && window.ENV_CONFIG) {
                            apiKey = apiKey || window.ENV_CONFIG.METAAPI_API_KEY || '';
                            accountId = accountId || window.ENV_CONFIG.METAAPI_ACCOUNT_ID || '';
                            region = region || window.ENV_CONFIG.METAAPI_REGION || 'new-york';
                            if (apiKey && accountId) {
                                source = 'config';
                                console.log('Found credentials in config:', { hasApiKey: !!apiKey, hasAccountId: !!accountId, region });
                            }
                        }
                    }
                    
                    // Auto-fill the form fields if we found values
                    if (apiKey) {
                        $('#metaapi-key').val(apiKey);
                        console.log('Auto-populated API key from', source);
                        logger.logApi('METAAPI_KEY_AUTO_POPULATED', { source });
                    }
                    if (accountId) {
                        $('#metaapi-account').val(accountId);
                        console.log('Auto-populated Account ID from', source);
                        logger.logApi('METAAPI_ACCOUNT_AUTO_POPULATED', { source });
                    }
                    if (region) {
                        $('#metaapi-region').val(region);
                        console.log('Auto-populated region from', source, ':', region);
                        logger.logApi('METAAPI_REGION_AUTO_POPULATED', { source, region });
                    }
                    
                    // If both credentials are available and auto-initialize is enabled, auto-initialize MetaAPI
                    if (apiKey && accountId && settings.auto_initialize_metaapi) {
                        console.log('Credentials ready for auto-initialization from', source);
                        logger.logApi('METAAPI_AUTO_INIT_STARTED', { hasApiKey: !!apiKey, hasAccountId: !!accountId, source });
                        
                        // Update status to connecting
                        metaAPIStatusManager.setConnecting('Auto-initializing...');
                        
                        // Update UI to show auto-initializing state
                        const $btn = $('#metaapi-connect-btn');
                        $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Auto-initializing...');
                        $('#metaapi-status').show().removeClass('alert-success alert-danger alert-warning').addClass('alert-info');
                        const sourceText = source === 'settings' ? 'saved credentials' : 'configuration';
                        $('#metaapi-status-text').text(`Auto-initializing MetaAPI with ${sourceText}...`);
                        
                        try {
                            // Initialize MetaAPI (simple connection, no sync wait)
                            await metaAPIService.initialize(apiKey, accountId, region);
                            
                            // Update UI for successful initialization
                            metaAPIInitialized = true;
                            metaAPIStatusManager.setConnected('Auto-initialized successfully');
                            $btn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> MetaAPI Ready');
                            $('#metaapi-status').removeClass('alert-info').addClass('alert-success');
                            $('#metaapi-status-text').html('<i class="bi bi-check-circle"></i> MetaAPI auto-initialized successfully! Data will be fetched on-demand when needed.');
                            
                            logger.logApi('METAAPI_AUTO_INIT_SUCCESS', { accountId, region, source });
                            console.log('MetaAPI auto-initialized successfully from', source);
                            
                            // Save credentials to settings if they came from config
                            if (source === 'config') {
                                settingsManager.saveSetting('metaapi_key', apiKey);
                                settingsManager.saveSetting('metaapi_account', accountId);
                                settingsManager.saveSetting('metaapi_region', region);
                                logger.logApi('METAAPI_CREDENTIALS_SAVED_FROM_CONFIG', { accountId, region });
                            }
                            
                            // Fetch and populate symbols
                            await fetchAndPopulateSymbols();
                            
                            // Refresh current pair if selected
                            const currencyPair = $('#currency-pair').val();
                            if (currencyPair) {
                                fetchForexRate(currencyPair, true);
                            }
                            
                        } catch (error) {
                            // Update UI for failed initialization
                            metaAPIInitialized = false;
                            metaAPIStatusManager.setDisconnected('Auto-initialization failed');
                            $btn.prop('disabled', false).html('<i class="bi bi-plug"></i> Initialize MetaAPI');
                            
                            $('#metaapi-status').removeClass('alert-info').addClass('alert-warning');
                            $('#metaapi-status-text').html(`<i class="bi bi-exclamation-triangle"></i> Auto-initialization failed: ${error.message}. Click "Initialize MetaAPI" to retry.`);
                            
                            logger.logError('METAAPI_AUTO_INIT_FAILED', error.message, { accountId, region, source });
                            console.warn('MetaAPI auto-initialization failed:', error);
                        }
                    } else {
                        console.log('Auto-initialization skipped:', { 
                            hasApiKey: !!apiKey, 
                            hasAccountId: !!accountId, 
                            autoInit: settings.auto_initialize_metaapi 
                        });
                        metaAPIStatusManager.setDisconnected('Please configure MetaAPI credentials');
                        $('#metaapi-status').show().removeClass('alert-success').addClass('alert-warning');
                        $('#metaapi-status-text').text('Please enter your MetaAPI credentials or check your configuration file.');
                    }
                    
                } catch (error) {
                    console.error('Auto-populate failed:', error);
                    metaAPIStatusManager.setDisconnected('Initialization error');
                    logger.logError('AUTO_POPULATE_CREDENTIALS_FAILED', error.message);
                }
            }
            
            // Initialize everything after a short delay to ensure config.js has loaded
            setTimeout(autoPopulateAndInitialize, 1000);
            
            // Also try again after 2 seconds in case config loading is slow
            setTimeout(function() {
                if (!metaAPIInitialized && (!$('#metaapi-key').val() || !$('#metaapi-account').val())) {
                    console.log('Retrying credential auto-population...');
                    autoPopulateAndInitialize();
                }
            }, 2000);
            
            // Initialize with default selections
            if ($('#currency-pair').val()) {
                fetchForexRate($('#currency-pair').val(), true);
                fetchATR($('#currency-pair').val(), globalTimeframe, $('#atr-periods').val());
            }
            
            // Log initial timeframe
            logger.logCalculation('INITIAL_TIMEFRAME_SET', { timeframe: globalTimeframe });
            
            // Initialize MetaAPI status
            logger.logApi('METAAPI_INITIALIZATION', { status: 'Ready for connection' });
        });
    </script>


</body></html>
